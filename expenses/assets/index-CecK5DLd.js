(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const T=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,E=Math.floor(window.innerWidth*.9),h=Math.floor(150*E/320);let I=parseFloat(localStorage.getItem("max")||"3000"),b=parseFloat(localStorage.getItem("budget")||"2000"),v=localStorage.getItem("graphtype")||"bar",c=[];const C=document.getElementById("canvas");C.width=E;C.height=h;const d=C.getContext("2d"),$=document.querySelector("#periodFilter"),D=document.querySelector("#periodFilter2"),Z=document.querySelector("#categories"),ee=document.querySelector("#payments"),te=document.querySelector("#total"),ne=document.querySelector("#percentage"),_=document.getElementById("frmImport"),z=document.getElementById("importFile"),L=document.getElementById("expenses"),oe=document.getElementById("frmSettings"),re=document.getElementById("search"),M=document.getElementById("progress"),A=document.querySelector("#toast");var N;(N=document.getElementById("btnImport"))==null||N.addEventListener("click",J);z.addEventListener("change",fe);var B;(B=document.getElementById("btnExport"))==null||B.addEventListener("click",ge);var H;(H=document.getElementById("btnExample"))==null||H.addEventListener("click",ye);var R;(R=document.getElementById("btnClear"))==null||R.addEventListener("click",he);var k;(k=document.getElementById("btnAddExpense"))==null||k.addEventListener("click",ie);var j;(j=document.getElementById("btnSaveSettings"))==null||j.addEventListener("click",me);var q;(q=document.getElementById("search"))==null||q.addEventListener("keyup",p);D.addEventListener("ionChange",p);$.addEventListener("ionChange",p);document.addEventListener("ionViewDidEnter",V);function V(){L.elements.date.value=u(new Date,"y-M-d"),c.length==0&&confirm("No payments found. Load example data?")&&(K(),J())}function ae(){localStorage.getItem("payments")||localStorage.setItem("payments","[]"),setTimeout(V,1e3),c=JSON.parse(localStorage.getItem("payments")||"[]"),c=c.filter(n=>se(n.name,n.date,n.category,n.amount)),c.forEach(n=>{n.date=new Date(n.date).toISOString(),n.amount=parseFloat(n.amount.toString()),n.period=u(n.date,"y-M"),n.day=u(n.date,"y-M-d")});let t=new Date(u(new Date,"y-M")+"-01");t.setTime(t.getTime()-24*60*60*1e3);let e=u(t,"y-M");W(u(new Date,"y-M"),e),p(),S("budget",b),S("max",I),S("graphType",v)}function ie(){const t=Object.assign(...Array.from(new FormData(L).entries(),([e,n])=>({[e]:n})));G(t)&&(f(`Payment ${t.amount} ${t.name} (${t.category}) saved`),p(),Y())}function f(t){A.message=t,A.present()}function G({name:t,date:e,category:n,amount:o}){const r=new Date,a=e.length===10,i=new Date(e);a&&i.setHours(r.getHours(),r.getMinutes(),r.getSeconds());try{P(t,i,n,o);const l=Ee(length),s=u(i,"y-M"),m=u(i,"y-M-d");return o=parseFloat(o),c.find(g=>g.day===m&&g.category===n&&g.amount===o)&&console.warn(`Possible duplicate payment: day: ${m}, category: ${n}, amount=${o}`),c.push({id:l,name:t,category:n,amount:o,date:i.toISOString(),period:s,day:m}),c=c.sort(ve),F(),!0}catch(l){return f(`ERROR: ${l.message} in record ${t}, ${e}, ${n}, ${o}`),!1}}function se(t,e,n,o){try{return P(t,e,n,o),!0}catch{return!1}}function P(t,e,n,o){if(!e||!Date.parse(e))throw new Error(`Date missing/invalid in record ${t}, ${e}, ${n}, ${o}`);if(!t)throw new Error(`Text missing in record ${t}, ${e}, ${n}, ${o}`);if(!n)throw new Error(`Category missing in record ${t}, ${e}, ${n}, ${o}`);if(isNaN(parseFloat(o)))throw new Error(`Amount must be a number in record ${t}, ${e}, ${n}, ${o}`);return!0}function le(t){confirm("Definitely delete?")&&(c=c.filter(e=>e.id!==t),F(),p())}window.deletePayment=le;function p(){const t=re.value||"",e=$.value,n=D.value,o=c.filter(s=>!e||s.period===e).filter(ce(t)),r=o.map(s=>s.amount).reduce((s,m)=>s+m,0);let a=r/b;M.value=a,a>1?M.color="danger":M.color="primary",ne.innerHTML=Math.floor(a*100)+"%",te.innerHTML="CHF "+r.toFixed(2);let i='<ion-grid fixed="true">',l="";o.map(s=>({...s,amountFormatted:s.amount.toFixed(2)})).forEach(s=>{l!==s.day&&(i+=`<ion-row style="background-color: silver"><ion-col size="12"><b>${Ie(s.date)}</b></ion-col></ion-row>`),l=s.day,i+=`<ion-row><ion-col size="2" title="${s.date}">${De(s.date)}</ion-col><ion-col size="6" class="ion-text-nowrap">${s.name}</ion-col><ion-col size="3" class="ion-text-right">${s.amountFormatted}</ion-col><ion-col size="1"><a href="javascript:deletePayment('${s.id}')"><ion-icon name="trash-outline"></ion-icon></a></ion-row>`}),i+="</ion-grid>",ee.innerHTML=i,(e||n)&&U(),n&&O(n,"red"),e&&O(e,"blue")}function ce(t){return e=>!t||[e.name,e.category,e.amount,e.day].join(" ").toLowerCase().includes(t.toLowerCase())}function W(t,e){de(t,e),Y()}function de(t,e){let n=Array.from(new Set(c.map(o=>o.period).sort(Se)));$.innerHTML=n.map(o=>`<ion-select-option ${o===t?"selected":""} value="${o}">${o}</ion-select-option>`).join(`
`),$.value=t,D.innerHTML=n.map(o=>`<ion-select-option ${o===e?"selected":""} value="${o}">${o}</ion-select-option>`).join(`
`),D.value=e}function Y(t){let e=Array.from(new Set(c.map(n=>n.category).sort($e)));Z.innerHTML=e.map(n=>`<ion-chip onclick="setCategory(this, '${n}')">${n}</ion-chip>`).join(`
`)}let x=null;function ue(t,e){x&&x.setAttribute("color",""),t.setAttribute("color","primary"),L.category.value=e,x=t}window.setCategory=ue;function O(t,e){let n=c.filter(l=>l.period===t),o=0;const r=Q(t);let a={red:"rgba(255, 0, 0, 0.5)",green:"rgba(0, 255, 0, 0.5)",blue:"rgba(0, 0, 255, 0.5)"}[e];const i=new Date;r.forEach(l=>{const s=n.filter(y=>y.day>l);if(new Date(l)>i&&s.length==0)return;const g=n.filter(y=>y.day===l).reduce((y,w)=>y+w.amount,0);o+=g,X(r.indexOf(l),o,a)})}function me(){let t=oe,e=isNaN(parseFloat(t.budget.value))?0:parseFloat(t.budget.value);if(!e)return f("Invalid budget");let n=isNaN(parseFloat(t.max.value))?0:parseFloat(t.max.value);if(!n)return f("Invalid max spend");v=t.graphType.value,localStorage.setItem("budget",e.toString()),localStorage.setItem("max",n.toString()),localStorage.setItem("graphtype",v),b=e,I=n,U(),p()}function fe(){const t=new FileReader;t.onload=e=>{var n;return _.import.value=(n=e.target)==null?void 0:n.result};for(let e of z.files)t.readAsText(e)}function ge(){let t=`Date,Text,Amount,Category
`;t+=c.map(e=>`${u(e.date,"y-M-d h:m:s")},"${e.name}",${e.amount},${e.category}`).join(`
`),we("payments.csv",t),f("Exported payments to payments.csv")}function J(){try{const t=_.import.value;if(!t)throw new Error("No data to import");let e=t.split(`
`);if(!e.length)throw new Error("No data to import");let n=/(".*?"|[^",]+)(?=\s*,|\s*$)/g,o=e[0].match(n);if(o.length!=4&&(n=/\t/g,o=e[0].match(n),o.length!=4))throw new Error("Header mismatch: Should be 4 comma- (*.csv) or tab-separated (*.tsv) headers: Date, Text, Amount, Category");if(o[0].trim()!=="Date"||o[1].trim()!=="Text"||o[2].trim()!=="Amount"||o[3].trim()!=="Category")throw new Error("Headers mismatch: Should be: Date, Text, Amount, Category");e=e.slice(1).filter(i=>!!i.trim());let r=0;const a=e.map((i,l)=>{if(i.trim()==="")return null;const s=i.match(n);if(s.length<4)throw new Error(`Data mismatch: Should be comma- (*.csv) or tab-separated (*.tsv): Date, Text, Amount, Category (Line ${l}): ${i}`);let[m,g,y,w]=s;return m=m.trim(),g=g.replace(/^"/g,"").replace(/"$/g,"").trim(),y=y.trim(),w=w.trim(),P(g,new Date(m),w,y),{name:g,amount:y,category:w,date:m}}).filter(i=>!!i);if(a.length<e.length)return f("Cancelling due to invalid payments found!");a.forEach(i=>{G(i)&&r++}),p(),W(),f(`Imported ${r}/${e.length} payments successfully`)}catch(t){console.error(t.message),console.error(t.stack),f(`Validation Error: ${t.message}`);return}}function K(){let t=new Date,e=u(t,"y-M"),n=u(new Date(Date.now()-t.getDate()*24*3600*1e3),"y-M");S("import",["Date,Text,Amount,Category",`${n}-01,"Food",180.25,Food`,`${n}-02,"Rent Costs",100,Flat`,`${n}-03,"Dog Food",100,Pets`,`${n}-04,"SwissLife",100,Pension`,`${n}-05,"Car Insurance",100,Insurance`,`${e}-01,"Food",100,Food`,`${e}-02,"Rent Costs",100,Flat`,`${e}-03,"Dog Food",80,Pets`,`${e}-04,"SwissLife",10,Pension`,`${e}-05,"Car Insurance",10,Insurance`].join(`
`))}function S(t,e){const n=document.getElementById(t);n.value=e}function ye(){K(),f("Example data loaded. Click Import to add it")}function he(){confirm("Definitely clear all payment data?")&&(c=[],F(),p(),f("Payments cleared"))}function U(){d.clearRect(0,0,E,h),d.fillStyle=T?"#333":"white",d.fillRect(0,0,E,h),d.font="8pt sans-serif",d.strokeStyle=T?"#ccc":"gray",d.fillStyle=d.strokeStyle,d.lineWidth=1;let t=500;const e=Math.ceil(I/t);for(let r=0;r<e;r++){const a=(t*(e-r)).toString();d.fillText(a,0,r*h/e),d.beginPath(),d.moveTo(0,r*h/e),d.lineTo(E,r*h/e),d.stroke()}$.value;const n=Q(u(new Date,"y-")+"01"),o=b/n.length;n.forEach((r,a)=>{X(n.indexOf(r),(a+1)*o,"rgba(100, 100, 100, 0.5)")})}function X(t,e,n){d.fillStyle=n;const o=E/32,r=e*h/I;v==="line"?d.fillRect(t*o,h-r,o,2):d.fillRect(t*o,h-r,o,r)}function Q(t){if(!t)return[];const e=parseInt(t.substring(0,4),10),n=parseInt(t.substring(5,7),10),o=pe(e,n);return new Array(o).fill(0).map((r,a)=>u(new Date(e,n-1,a+1),"y-M-d"))}function pe(t,e){return new Date(t,e,0).getDate()}function we(t,e){var n=document.createElement("a");n.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(e)),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function u(t,e="y-M-d"){const n=new Date(t),o={y:n.getFullYear().toString(),M:("0"+(n.getMonth()+1)).toString().slice(-2),d:("0"+n.getDate()).toString().slice(-2),h:("0"+n.getHours()).toString().slice(-2),m:("0"+n.getMinutes()).toString().slice(-2),s:("0"+n.getSeconds()).toString().slice(-2)},r=Object.keys(o).join(""),a=new RegExp(`(?<!\\\\)[${r}]`,"g"),i=new RegExp(`\\\\([${r}])`,"g");return e.replace(a,l=>o[l]).replace(i,(l,s)=>s)}function Ee(t){return Math.random().toString(36).replace("0.","")}function $e(t,e){return t>e?1:-1}function Se(t,e){return t<e?1:-1}function ve(t,e){return t.day<e.day?1:-1}function De(t){return new Date(t).toLocaleString("en-us",{month:"short",day:"numeric"})}function Ie(t){return new Date(t).toLocaleString("en-us",{weekday:"short",day:"numeric"})}function F(){const t=c.map(e=>({id:e.id,name:e.name,date:u(e.date,"y-M-d h:m:s"),category:e.category,amount:e.amount}));localStorage.setItem("payments",JSON.stringify(t))}function be(t){f(`ERROR: ${t.message}`)}window.addEventListener("load",ae);window.addEventListener("error",be);
