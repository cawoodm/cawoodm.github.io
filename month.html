<html>

<head>
  <title>Monthly Expenses</title>
</head>

<body>
  <form id="post" onsubmit="event.preventDefault(); postPayment(this)">
    <input placeholder="Description" name="name" required/>
    <input placeholder="Amount" name="amount" pattern="^\d*(\.\d{0,2})?$" size="4" required/>
    <br>
    <select name="category" required>
      <option value="">Category</option>
      <option value="Flat">Flat</option>
      <option value="Food">Food</option>
      <option value="Josie">Josie</option>
      <option value="Sophia">Sophia</option>
      <option value="Holiday">Holiday</option>
      <option value="Vehicles">Vehicles</option>
      <option value="Insurance">Insurance</option>
      <option value="Pension">Pension</option>
      <option value="Extra">Extra</option>
      <option value="Other">Other</option>
    </select>
    <input placeholder="Date" name="date" type="date" required/>
    <input type="submit" value="Submit" />
  </form>
  <div>
    <select id="periodFilter"></select><br>
    <canvas id="canvas" width="320" height="150" style="border:1px solid grey"></canvas>
  </div>
  <details>
    <summary>Details</summary>
    <div id="payments"></div>
  </details>
  <details>
    <summary>Import</summary>
    <form onsubmit="event.preventDefault(); doImport(this)">
      <textarea name="import" style="width: 100%; height: 200px"></textarea>
      <input type="submit" value="Import"/>
    </form>
  </details>
  
  <script>
    const CANVAS_WIDTH = 320;
    const CANVAS_HEIGHT = 150;
    const MAX_SPEND = 3000;
    /*
    Payment: {id, name, date, category, amount}
    */
    let payments = [];
    let periods = [];
    const elPayments = document.querySelector('div#payments');
    const ctx = document.getElementById("canvas").getContext("2d");
    const elDate = document.querySelector('form#post input[name="date"]');
    const elPeriodsFilter = document.querySelector('select#periodFilter');

    function init() {
      if (!localStorage.getItem('payments')) localStorage.setItem('payments', '[]');
      payments = JSON.parse(localStorage.getItem('payments'));
      payments.forEach(payment => {
        payment.date = new Date(payment.date);
        payment.amount = parseFloat(payment.amount, 10);
        payment.period = formatDate(payment.date, 'y-M');
        payment.day = formatDate(payment.date, 'y-M-d');
        if (periods.indexOf(payment.period) === -1) periods.push(payment.period);
      });
      periods = periods.sort(descending);
      let todaysPeriod = formatDate(new Date(), 'y-M');
      //todaysPeriod = '2024-12'; // TODO: Debug remove
      elPeriodsFilter.innerHTML = `<option></option>${periods.map(period => `<option ${period === todaysPeriod ? 'selected' : ''} value="${period}">${period}</option>`).join('\n')}`;
      elPeriodsFilter.addEventListener('change', listPayments);
      resetChart();
      listPayments();
      elDate.value = formatDate(new Date(), 'y-M-d');
    }

    function postPayment(frm) {
      const o = Object.assign(...Array.from(new FormData(frm).entries(), ([x,y]) => ({[x]:y})));
      savePayment(o);
      listPayments();
      return false;
    }
    function savePayment({name, date, category, amount}) {
      const parsedDate = new Date(date);
      if (!validatePayment(name, parsedDate, category, amount)) return false;
      const id = randomId(length); //new Date().toISOString().replace(/[T:Z\-\.]/g, '');
      const period = formatDate(parsedDate, 'y-M');
      const day = formatDate(parsedDate, 'y-M-d');
      amount = parseFloat(amount);
      if (payments.find(p => p.day === day && p.category === category && p.amount === amount)) console.warn(`Possible duplicate payment: day: ${day}, category: ${category}, amount=${amount}`);
      payments.push({id, name, category, amount, date: parsedDate, period, day});
      save();
      return true;
    }
    function validatePayment(name, date, category, amount) {
      if (!date) return alert('Date missing');
      if (!name) return alert('Description missing');
      if (!category) return alert('Category missing');
      if (!parseFloat(amount)) return alert('Amount must be a number');
      return true;
    }

    function deletePayment(id) {
      if (!confirm("Definitely delete?")) return;
      payments = payments.filter(payment => payment.id !== id);
      save();
      listPayments();
    }

    function listPayments() {
      elPayments.innerHTML = '';
      let html = '<ul>';
      const filteredPeriod = elPeriodsFilter.options[elPeriodsFilter.selectedIndex].value;
      const filteredPayments = payments.filter(payment => !filteredPeriod || payment.date.toISOString().substring(0, 7) === filteredPeriod);
      filteredPayments.forEach(payment => {
        html += `<li>${fmtDate(payment.date)} - ${payment.name} - ${parseFloat(payment.amount).toFixed(2)} <a href="javascript:deletePayment('${payment.id}')">X</a></li>`;
      });
      html += '</ul>';
      elPayments.innerHTML = html;
      if (filteredPeriod) chartPayments(filteredPayments, filteredPeriod);
    }

    function chartPayments(payments, filteredPeriod) {
//      resetChart();
      let sum = 0;
      const days = getDaysOfMonth(filteredPeriod);
      days.forEach(day => {
        const dayPayments = payments.filter(payment => payment.day === day);
        const daySum = dayPayments.reduce((acc, payment) => acc + payment.amount, 0);
        sum += daySum;
        bar(days.indexOf(day), sum, 'rgba(0, 0, 255, 0.5)');
      });
    }

    function doImport(frm) {
      try {
        const importData = frm.import.value;
        if (!importData) throw new Error('No data to import');
        const lines = importData.split('\n');
        if (!lines.length) throw new Error('No data to import');
        let success = 0;
        const validPayments = lines
          .map((line, i) => {
            const parts = line.split('\t');
            if (i===0) {
              if (parts[0] !== 'date' || parts[1] !== 'name' || parts[2] !== 'category' || parts[3] !== 'amount') throw new Error('Headers mismatch: Should be TSV: date, name, category, amount');
              return;
            }
            if (parts.length < 4) throw new Error(`Data mismatch: Should be TSV: date, name, category, amount (Line ${i}): ${line}`);
            let [date, name, category, amount] = parts;
            name = name.replace(/^"/g, '').replace(/"$/g, '');
            if (!validatePayment(name, new Date(date), category, amount))
              return null;
            return {name, amount, category, date};
          })
          .filter(payment => !!payment);

        if (validPayments.length < (lines.length -1)) return alert('Cancelling due to invalid payments found!');

        validPayments.forEach(payment => {
          if (savePayment(payment)) success++;
        });
        listPayments();
        alert(`Imported ${success}/${lines.length-1} payments successfully`);

      } catch (e) {
        console.log(e.stack);
        alert(`Validation Error: ${e.message}`);
        return;
      }
    }

    function resetChart() {
      ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
      ctx.font = '8pt sans-serif';
      ctx.strokeStyle = 'gray';
      ctx.lineWidth = 1;
      const LINES = Math.ceil(MAX_SPEND / 1000);
      ctx.fillStyle = "#435a6b";
      for(let i = 0; i < LINES; i++) {
        ctx.fillText(1000 * (LINES - i), 0, i * CANVAS_HEIGHT / LINES);
        ctx.beginPath();
        ctx.moveTo(0, i * CANVAS_HEIGHT / LINES);
        ctx.lineTo(CANVAS_WIDTH, i * CANVAS_HEIGHT / LINES);
        ctx.stroke();
      }
    }

    function bar(x, h, col) {
      ctx.fillStyle = col;
      const W = CANVAS_WIDTH / 32;
      ctx.fillRect(x * W, CANVAS_HEIGHT, W, -(h * CANVAS_HEIGHT) / MAX_SPEND);
    }

    function getDaysOfMonth(period) {
      const year = parseInt(period.substring(0, 4), 10);
      const month = parseInt(period.substring(5, 7), 10);
      const dayCount = daysInMonth(year, month);
      return new Array(dayCount).fill(0).map((_, i) => formatDate(new Date(year, month - 1, i + 1), "y-M-d"));
    }

    function daysInMonth(year, month) {
      return new Date(year, month, 0).getDate();
    }

    function formatDate(date, format = 'Y-m-d') {
      const parts = {
        y: date.getFullYear().toString(),
        M: ('0' + (date.getMonth() + 1)).toString().slice(-2),
        d: ('0' + date.getDate()).toString().slice(-2),
        h: ('0' + date.getHours()).toString().slice(-2),
        m: ('0' + date.getMinutes()).toString().slice(-2),
        s: ('0' + date.getSeconds()).toString().slice(-2)
      };

      const modifiers = Object.keys(parts).join('');
      const reDate = new RegExp(`(?<!\\\\)[${modifiers}]`, 'g');
      const reEscape = new RegExp(`\\\\([${modifiers}])`, 'g');

      return format
        .replace(reDate, $0 => parts[$0])
        .replace(reEscape, ($0, $1) => $1);
    }

    function randomId(length) {
      return Math.random().toString(36).replace('0.', '');
  }

    function ascending(a, b) {
      return a > b ? 1 : -1;
    }

    function descending(a, b) {
      return a < b ? 1 : -1;
    }

    function fmtDate(dt) {
      return dt.toLocaleString('en-us', {weekday: "short", year: "numeric", month: "short", day: "numeric"});
    }

    function save() {
      localStorage.setItem('payments', JSON.stringify(payments));
    }

    window.addEventListener('load', init);
  </script>

</body>

</html>