(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const F=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,$=Math.floor(window.innerWidth*.9),y=Math.floor(150*$/320);let I=parseFloat(localStorage.getItem("max")||"3000"),b=parseFloat(localStorage.getItem("budget")||"2000"),v=localStorage.getItem("graphtype")||"bar",d=[];const L=document.getElementById("canvas");L.width=$;L.height=y;const l=L.getContext("2d"),E=document.querySelector("#periodFilter"),D=document.querySelector("#periodFilter2"),K=document.querySelector("#categories"),U=document.querySelector("#payments"),X=document.querySelector("#total"),Q=document.querySelector("#percentage"),Z=document.getElementById("frmImport"),x=document.getElementById("expenses"),ee=document.getElementById("frmSettings"),te=document.getElementById("search"),M=document.getElementById("progress"),T=document.querySelector("#toast");var N;(N=document.getElementById("btnImport"))==null||N.addEventListener("click",V);var O;(O=document.getElementById("btnExample"))==null||O.addEventListener("click",ue);var H;(H=document.getElementById("btnClear"))==null||H.addEventListener("click",me);var B;(B=document.getElementById("btnAddExpense"))==null||B.addEventListener("click",re);var R;(R=document.getElementById("btnSaveSettings"))==null||R.addEventListener("click",de);var k;(k=document.getElementById("search"))==null||k.addEventListener("keyup",p);D.addEventListener("ionChange",p);E.addEventListener("ionChange",p);document.addEventListener("ionViewDidEnter",ne);function ne(){ce("initForm"),x.elements.date.value=u(new Date,"y-M-d"),d.length==0&&confirm("No payments found. Load example data?")&&(G(),V())}function oe(){localStorage.getItem("payments")||localStorage.setItem("payments","[]"),d=JSON.parse(localStorage.getItem("payments")||"[]"),d.forEach(n=>{n.date=new Date(n.date),n.amount=parseFloat(n.amount),n.period=u(n.date,"y-M"),n.day=u(n.date,"y-M-d")});let e=new Date(u(new Date,"y-M")+"-01");e.setTime(e.getTime()-24*60*60*1e3);let t=u(e,"y-M");_(u(new Date,"y-M"),t),p(),S("budget",b),S("max",I),S("graphType",v)}function re(){const e=Object.assign(...Array.from(new FormData(x).entries(),([t,n])=>({[t]:n})));j(e),g(`Payment ${e.amount} ${e.name} (${e.category}) saved`),p(),z()}function g(e){T.message=e,T.present()}function j({name:e,date:t,category:n,amount:o}){const r=new Date,a=new Date(t);a.setHours(r.getHours(),r.getMinutes(),r.getSeconds());try{q(e,a,n,o);const i=ge(length),c=u(a,"y-M"),s=u(a,"y-M-d");return o=parseFloat(o),d.find(m=>m.day===s&&m.category===n&&m.amount===o)&&console.warn(`Possible duplicate payment: day: ${s}, category: ${n}, amount=${o}`),d.push({id:i,name:e,category:n,amount:o,date:a,period:c,day:s}),d=d.sort(he),C(),!0}catch(i){g(`ERROR: ${i.message} in record ${e}, ${t}, ${n}, ${o}`)}}function q(e,t,n,o){if(!t)throw new Error(`Date missing in record ${e}, ${t}, ${n}, ${o}`);if(!e)throw new Error(`Text missing in record ${e}, ${t}, ${n}, ${o}`);if(!n)throw new Error(`Category missing in record ${e}, ${t}, ${n}, ${o}`);if(isNaN(parseFloat(o)))throw new Error(`Amount must be a number in record ${e}, ${t}, ${n}, ${o}`);return!0}function ae(e){confirm("Definitely delete?")&&(d=d.filter(t=>t.id!==e),C(),p())}window.deletePayment=ae;function p(){const e=te.value||"",t=E.value,n=D.value,o=d.filter(s=>!t||s.period===t).filter(ie(e)),r=o.map(s=>s.amount).reduce((s,m)=>s+m,0);let a=r/b;M.value=a,a>1?M.color="danger":M.color="primary",Q.innerHTML=Math.floor(a*100)+"%",X.innerHTML="CHF "+r.toFixed(2);let i='<ion-grid fixed="true">',c="";o.map(s=>({...s,amountFormatted:s.amount.toFixed(2)})).forEach(s=>{c!==s.day&&(i+=`<ion-row style="background-color: silver"><ion-col size="12"><b>${$e(s.date)}</b></ion-col></ion-row>`),c=s.day,i+=`<ion-row><ion-col size="2" title="${s.date}">${we(s.date)}</ion-col><ion-col size="6" class="ion-text-nowrap">${s.name}</ion-col><ion-col size="3" class="ion-text-right">${s.amountFormatted}</ion-col><ion-col size="1"><a href="javascript:deletePayment('${s.id}')"><ion-icon name="trash-outline"></ion-icon></a></ion-row>`}),i+="</ion-grid>",U.innerHTML=i,(t||n)&&W(),n&&A(n,"red"),t&&A(t,"blue")}function ie(e){return t=>!e||[t.name,t.category,t.amount,t.day].join(" ").toLowerCase().includes(e.toLowerCase())}function _(e,t){se(e,t),z()}function se(e,t){let n=Array.from(new Set(d.map(o=>o.period).sort(pe)));E.innerHTML=n.map(o=>`<ion-select-option ${o===e?"selected":""} value="${o}">${o}</ion-select-option>`).join(`
`),E.value=e,D.innerHTML=n.map(o=>`<ion-select-option ${o===t?"selected":""} value="${o}">${o}</ion-select-option>`).join(`
`),D.value=t}function z(e){let t=Array.from(new Set(d.map(n=>n.category).sort(ye)));K.innerHTML=t.map(n=>`<ion-chip onclick="setCategory(this, '${n}')">${n}</ion-chip>`).join(`
`)}let P=null;function le(e,t){P&&P.setAttribute("color",""),e.setAttribute("color","primary"),x.category.value=t,P=e}window.setCategory=le;function A(e,t){let n=d.filter(c=>c.period===e),o=0;const r=J(e);let a={red:"rgba(255, 0, 0, 0.5)",green:"rgba(0, 255, 0, 0.5)",blue:"rgba(0, 0, 255, 0.5)"}[t];const i=new Date;r.forEach(c=>{const s=n.filter(f=>f.day>c);if(new Date(c)>i&&s.length==0)return;const h=n.filter(f=>f.day===c).reduce((f,w)=>f+w.amount,0);o+=h,Y(r.indexOf(c),o,a)})}const ce=console.log;function de(){let e=ee,t=isNaN(parseFloat(e.budget.value))?0:parseFloat(e.budget.value);if(!t)return g("Invalid budget");let n=isNaN(parseFloat(e.max.value))?0:parseFloat(e.max.value);if(!n)return g("Invalid max spend");v=e.graphType.value,localStorage.setItem("budget",t.toString()),localStorage.setItem("max",n.toString()),localStorage.setItem("graphtype",v),b=t,I=n,W(),p()}function V(){try{const e=Z.import.value;if(!e)throw new Error("No data to import");let t=e.split(`
`);if(!t.length)throw new Error("No data to import");let n="	",o=t[0].split(n);if(o.length!=4&&(n=",",o=t[0].split(n),o.length!=4))throw new Error("Header mismatch: Should be 4 comma- (*.csv) or tab-separated (*.tsv) headers: Date, Text, Amount, Category");if(o[0].trim()!=="Date"||o[1].trim()!=="Text"||o[2].trim()!=="Amount"||o[3].trim()!=="Category")throw new Error("Headers mismatch: Should be: Date, Text, Amount, Category");t=t.slice(1).filter(i=>!!i.trim());let r=0;const a=t.map((i,c)=>{if(i.trim()==="")return null;const s=i.split(n);if(s.length<4)throw new Error(`Data mismatch: Should be comma- (*.csv) or tab-separated (*.tsv): Date, Text, Amount, Category (Line ${c}): ${i}`);let[m,h,f,w]=s;return m=m.trim(),h=h.replace(/^"/g,"").replace(/"$/g,"").trim(),f=f.trim(),w=w.trim(),q(h,new Date(m),w,f),{name:h,amount:f,category:w,date:m}}).filter(i=>!!i);if(a.length<t.length)return g("Cancelling due to invalid payments found!");a.forEach(i=>{j(i)&&r++}),p(),_(),g(`Imported ${r}/${t.length} payments successfully`)}catch(e){console.error(e.message),console.error(e.stack),g(`Validation Error: ${e.message}`);return}}function G(){let e=new Date,t=u(e,"y-M"),n=u(new Date(Date.now()-e.getDate()*24*3600*1e3),"y-M");S("import",["Date,Text,Amount,Category",`${n}-01,"Food",180.25,Food`,`${n}-02,"Rent Costs",100,Flat`,`${n}-03,"Dog Food",100,Pets`,`${n}-04,"SwissLife",100,Pension`,`${n}-05,"Car Insurance",100,Insurance`,`${t}-01,"Food",100,Food`,`${t}-02,"Rent Costs",100,Flat`,`${t}-03,"Dog Food",80,Pets`,`${t}-04,"SwissLife",10,Pension`,`${t}-05,"Car Insurance",10,Insurance`].join(`
`))}function S(e,t){const n=document.getElementById(e);n.value=t}function ue(){G(),g("Example data loaded. Click Import to add it")}function me(){confirm("Definitely clear all payment data?")&&(d=[],C(),p(),g("Payments cleared"))}function W(){l.clearRect(0,0,$,y),l.fillStyle=F?"#333":"white",l.fillRect(0,0,$,y),l.font="8pt sans-serif",l.strokeStyle=F?"#ccc":"gray",l.fillStyle=l.strokeStyle,l.lineWidth=1;let e=500;const t=Math.ceil(I/e);for(let r=0;r<t;r++){const a=(e*(t-r)).toString();l.fillText(a,0,r*y/t),l.beginPath(),l.moveTo(0,r*y/t),l.lineTo($,r*y/t),l.stroke()}E.value;const n=J(u(new Date,"y-")+"01"),o=b/n.length;n.forEach((r,a)=>{Y(n.indexOf(r),(a+1)*o,"rgba(100, 100, 100, 0.5)")})}function Y(e,t,n){l.fillStyle=n;const o=$/32,r=t*y/I;v==="line"?l.fillRect(e*o,y-r,o,2):l.fillRect(e*o,y-r,o,r)}function J(e){if(!e)return[];const t=parseInt(e.substring(0,4),10),n=parseInt(e.substring(5,7),10),o=fe(t,n);return new Array(o).fill(0).map((r,a)=>u(new Date(t,n-1,a+1),"y-M-d"))}function fe(e,t){return new Date(e,t,0).getDate()}function u(e,t="y-M-d"){const n={y:e.getFullYear().toString(),M:("0"+(e.getMonth()+1)).toString().slice(-2),d:("0"+e.getDate()).toString().slice(-2),h:("0"+e.getHours()).toString().slice(-2),m:("0"+e.getMinutes()).toString().slice(-2),s:("0"+e.getSeconds()).toString().slice(-2)},o=Object.keys(n).join(""),r=new RegExp(`(?<!\\\\)[${o}]`,"g"),a=new RegExp(`\\\\([${o}])`,"g");return t.replace(r,i=>n[i]).replace(a,(i,c)=>c)}function ge(e){return Math.random().toString(36).replace("0.","")}function ye(e,t){return e>t?1:-1}function pe(e,t){return e<t?1:-1}function he(e,t){return e.day<t.day?1:-1}function we(e){return e.toLocaleString("en-us",{month:"short",day:"numeric"})}function $e(e){return e.toLocaleString("en-us",{weekday:"short",day:"numeric"})}function C(){const e=d.map(t=>({id:t.id,name:t.name,date:u(t.date,"y-M-d h:m:s"),category:t.category,amount:t.amount}));localStorage.setItem("payments",JSON.stringify(e))}function Ee(e){g(`ERROR: ${e.message}`)}window.addEventListener("load",oe);window.addEventListener("error",Ee);
