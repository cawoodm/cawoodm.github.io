(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();const L=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,w=Math.floor(window.innerWidth*.9),g=Math.floor(150*w/320);let I=parseFloat(localStorage.getItem("max")||"3000"),b=parseFloat(localStorage.getItem("budget")||"2000"),R=localStorage.getItem("graphtype")||"bar",u=[];const P=document.getElementById("canvas");P.width=w;P.height=g;const l=P.getContext("2d"),$=document.querySelector("#periodFilter"),S=document.querySelector("#periodFilter2"),Y=document.querySelector("#categories"),J=document.querySelector("#payments"),K=document.querySelector("#total"),U=document.querySelector("#percentage"),X=document.getElementById("frmImport"),C=document.getElementById("expenses");document.getElementById("frmSettings");const Q=document.getElementById("search"),M=document.getElementById("progress"),x=document.querySelector("#toast");var T;(T=document.getElementById("btnImport"))==null||T.addEventListener("click",_);var A;(A=document.getElementById("btnExample"))==null||A.addEventListener("click",re);var O;(O=document.getElementById("btnClear"))==null||O.addEventListener("click",ae);var H;(H=document.getElementById("btnAddExpense"))==null||H.addEventListener("click",ee);var N;(N=document.getElementById("search"))==null||N.addEventListener("keyup",y);S.addEventListener("ionChange",y);$.addEventListener("ionChange",y);function Z(){localStorage.getItem("payments")||localStorage.setItem("payments","[]"),u=JSON.parse(localStorage.getItem("payments")||"[]"),setTimeout(()=>{C.elements.date.value=d(new Date,"y-M-d"),u.length==0&&confirm("No payments found. Load example data?")&&(z(),_())},1e3),u.forEach(n=>{n.date=new Date(n.date),n.amount=parseFloat(n.amount),n.period=d(n.date,"y-M"),n.day=d(n.date,"y-M-d")});let e=new Date(d(new Date,"y-M")+"-01");e.setTime(e.getTime()-24*60*60*1e3);let t=d(e,"y-M");j(d(new Date,"y-M"),t),y(),E("budget",b),E("max",I),E("graphType",R)}function ee(){const e=Object.assign(...Array.from(new FormData(C).entries(),([t,n])=>({[t]:n})));B(e),D(`Payment ${e.amount} ${e.name} (${e.category}) saved`),y(),q()}function D(e){x.message=e,x.present()}function B({name:e,date:t,category:n,amount:o}){const r=new Date,a=new Date(t);a.setHours(r.getHours(),r.getMinutes(),r.getSeconds());try{k(e,a,n,o);const i=le(length),c=d(a,"y-M"),s=d(a,"y-M-d");return o=parseFloat(o),u.find(m=>m.day===s&&m.category===n&&m.amount===o)&&console.warn(`Possible duplicate payment: day: ${s}, category: ${n}, amount=${o}`),u.push({id:i,name:e,category:n,amount:o,date:a,period:c,day:s}),u=u.sort(ue),W(),!0}catch(i){alert(`ERROR: ${i.message} in record ${e}, ${t}, ${n}, ${o}`)}}function k(e,t,n,o){if(!t)throw new Error(`Date missing in record ${e}, ${t}, ${n}, ${o}`);if(!e)throw new Error(`Text missing in record ${e}, ${t}, ${n}, ${o}`);if(!n)throw new Error(`Category missing in record ${e}, ${t}, ${n}, ${o}`);if(isNaN(parseFloat(o)))throw new Error(`Amount must be a number in record ${e}, ${t}, ${n}, ${o}`);return!0}function y(){const e=Q.value||"",t=$.value,n=S.value,o=u.filter(s=>!t||s.period===t).filter(te(e)),r=o.map(s=>s.amount).reduce((s,m)=>s+m,0);let a=r/b;M.value=a,a>1?M.color="danger":M.color="primary",U.innerHTML=Math.floor(a*100)+"%",K.innerHTML="CHF "+r.toFixed(2);let i='<ion-grid fixed="true">',c="";o.map(s=>({...s,amountFormatted:s.amount.toFixed(2)})).forEach(s=>{c!==s.day&&(i+=`<ion-row style="background-color: silver"><ion-col size="12"><b>${fe(s.date)}</b></ion-col></ion-row>`),c=s.day,i+=`<ion-row><ion-col size="2" title="${s.date}">${me(s.date)}</ion-col><ion-col size="6" class="ion-text-nowrap">${s.name}</ion-col><ion-col size="3" class="ion-text-right">${s.amountFormatted}</ion-col><ion-col size="1"><a href="javascript:deletePayment('${s.id}')"><ion-icon name="trash-outline"></ion-icon></a></ion-row>`}),i+="</ion-grid>",J.innerHTML=i,(t||n)&&ie(),n&&F(n,"red"),t&&F(t,"blue")}function te(e){return t=>!e||[t.name,t.category,t.amount,t.day].join(" ").toLowerCase().includes(e.toLowerCase())}function j(e,t){ne(e,t),q()}function ne(e,t){let n=Array.from(new Set(u.map(o=>o.period).sort(de)));$.innerHTML=n.map(o=>`<ion-select-option ${o===e?"selected":""} value="${o}">${o}</ion-select-option>`).join(`
`),$.value=e,S.innerHTML=n.map(o=>`<ion-select-option ${o===t?"selected":""} value="${o}">${o}</ion-select-option>`).join(`
`),S.value=t}function q(e){let t=Array.from(new Set(u.map(n=>n.category).sort(ce)));Y.innerHTML=t.map(n=>`<ion-chip onclick="setCategory(this, '${n}')">${n}</ion-chip>`).join(`
`)}let v=null;function oe(e,t){v&&v.setAttribute("color",""),e.setAttribute("color","primary"),C.category.value=t,v=e}window.setCategory=oe;function F(e,t){let n=u.filter(c=>c.period===e),o=0;const r=V(e);let a={red:"rgba(255, 0, 0, 0.5)",green:"rgba(0, 255, 0, 0.5)",blue:"rgba(0, 0, 255, 0.5)"}[t];const i=new Date;r.forEach(c=>{const s=n.filter(f=>f.day>c);if(new Date(c)>i&&s.length==0)return;const h=n.filter(f=>f.day===c).reduce((f,p)=>f+p.amount,0);o+=h,G(r.indexOf(c),o,a)})}function _(){try{const e=X.import.value;if(!e)throw new Error("No data to import");let t=e.split(`
`);if(!t.length)throw new Error("No data to import");let n="	",o=t[0].split(n);if(o.length!=4&&(n=",",o=t[0].split(n),o.length!=4))throw new Error("Header mismatch: Should be 4 comma- (*.csv) or tab-separated (*.tsv) headers: Date, Text, Amount, Category");if(o[0].trim()!=="Date"||o[1].trim()!=="Text"||o[2].trim()!=="Amount"||o[3].trim()!=="Category")throw new Error("Headers mismatch: Should be: Date, Text, Amount, Category");t=t.slice(1).filter(i=>!!i.trim());let r=0;const a=t.map((i,c)=>{if(i.trim()==="")return null;const s=i.split(n);if(s.length<4)throw new Error(`Data mismatch: Should be comma- (*.csv) or tab-separated (*.tsv): Date, Text, Amount, Category (Line ${c}): ${i}`);let[m,h,f,p]=s;return m=m.trim(),h=h.replace(/^"/g,"").replace(/"$/g,"").trim(),f=f.trim(),p=p.trim(),k(h,new Date(m),p,f),{name:h,amount:f,category:p,date:m}}).filter(i=>!!i);if(a.length<t.length)return alert("Cancelling due to invalid payments found!");a.forEach(i=>{B(i)&&r++}),y(),j(),alert(`Imported ${r}/${t.length} payments successfully`)}catch(e){console.log(e.stack),alert(`Validation Error: ${e.message}`);return}}function z(){let e=new Date,t=d(e,"y-M"),n=d(new Date(Date.now()-e.getDate()*24*3600*1e3),"y-M");E("import",["Date,Text,Amount,Category",`${n}-01,"Food",180.25,Food`,`${n}-02,"Rent Costs",100,Flat`,`${n}-03,"Dog Food",100,Pets`,`${n}-04,"SwissLife",100,Pension`,`${n}-05,"Car Insurance",100,Insurance`,`${t}-01,"Food",100,Food`,`${t}-02,"Rent Costs",100,Flat`,`${t}-03,"Dog Food",80,Pets`,`${t}-04,"SwissLife",10,Pension`,`${t}-05,"Car Insurance",10,Insurance`].join(`
`))}function E(e,t){const n=document.getElementById(e);n.value=t}function re(){z(),D("Example data loaded. Click Import to add it")}function ae(){confirm("Definitely clear all payment data?")&&(u=[],W(),y(),D("Payments cleared"))}function ie(){l.clearRect(0,0,w,g),l.fillStyle=L?"#333":"white",l.fillRect(0,0,w,g),l.font="8pt sans-serif",l.strokeStyle=L?"#ccc":"gray",l.fillStyle=l.strokeStyle,l.lineWidth=1;let e=500;const t=Math.ceil(I/e);for(let r=0;r<t;r++){const a=(e*(t-r)).toString();l.fillText(a,0,r*g/t),l.beginPath(),l.moveTo(0,r*g/t),l.lineTo(w,r*g/t),l.stroke()}$.value;const n=V(d(new Date,"y-")+"01"),o=b/n.length;n.forEach((r,a)=>{G(n.indexOf(r),(a+1)*o,"rgba(100, 100, 100, 0.5)")})}function G(e,t,n){l.fillStyle=n;const o=w/32,r=t*g/I;R==="line"?l.fillRect(e*o,g-r,o,2):l.fillRect(e*o,g-r,o,r)}function V(e){if(!e)return[];const t=parseInt(e.substring(0,4),10),n=parseInt(e.substring(5,7),10),o=se(t,n);return new Array(o).fill(0).map((r,a)=>d(new Date(t,n-1,a+1),"y-M-d"))}function se(e,t){return new Date(e,t,0).getDate()}function d(e,t="y-M-d"){const n={y:e.getFullYear().toString(),M:("0"+(e.getMonth()+1)).toString().slice(-2),d:("0"+e.getDate()).toString().slice(-2),h:("0"+e.getHours()).toString().slice(-2),m:("0"+e.getMinutes()).toString().slice(-2),s:("0"+e.getSeconds()).toString().slice(-2)},o=Object.keys(n).join(""),r=new RegExp(`(?<!\\\\)[${o}]`,"g"),a=new RegExp(`\\\\([${o}])`,"g");return t.replace(r,i=>n[i]).replace(a,(i,c)=>c)}function le(e){return Math.random().toString(36).replace("0.","")}function ce(e,t){return e>t?1:-1}function de(e,t){return e<t?1:-1}function ue(e,t){return e.day<t.day?1:-1}function me(e){return e.toLocaleString("en-us",{month:"short",day:"numeric"})}function fe(e){return e.toLocaleString("en-us",{weekday:"short",day:"numeric"})}function W(){const e=u.map(t=>({id:t.id,name:t.name,date:d(t.date,"y-M-d h:m:s"),category:t.category,amount:t.amount}));localStorage.setItem("payments",JSON.stringify(e))}function ge(e){D(`ERROR: ${e.message}`)}window.addEventListener("load",Z);window.addEventListener("error",ge);
