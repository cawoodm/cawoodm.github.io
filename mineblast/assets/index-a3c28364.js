import*as g from"https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js";(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))h(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&h(n)}).observe(document,{childList:!0,subtree:!0});function c(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function h(s){if(s.ep)return;s.ep=!0;const a=c(s);fetch(s.href,a)}})();var O=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},H={},X={get exports(){return H},set exports(e){H=e}};(function(e,l){(function(c,h){e.exports=h()})(O,function(){var c=function(){function h(d){return n.appendChild(d.dom),d}function s(d){for(var f=0;f<n.children.length;f++)n.children[f].style.display=f===d?"block":"none";a=d}var a=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",function(d){d.preventDefault(),s(++a%n.children.length)},!1);var i=(performance||Date).now(),t=i,r=0,w=h(new c.Panel("FPS","#0ff","#002")),u=h(new c.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var p=h(new c.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:n,addPanel:h,showPanel:s,begin:function(){i=(performance||Date).now()},end:function(){r++;var d=(performance||Date).now();if(u.update(d-i,200),d>t+1e3&&(w.update(1e3*r/(d-t),100),t=d,r=0,p)){var f=performance.memory;p.update(f.usedJSHeapSize/1048576,f.jsHeapSizeLimit/1048576)}return d},update:function(){i=this.end()},domElement:n,setMode:s}};return c.Panel=function(h,s,a){var n=1/0,i=0,t=Math.round,r=t(window.devicePixelRatio||1),w=80*r,u=48*r,p=3*r,d=2*r,f=3*r,x=15*r,v=74*r,m=30*r,M=document.createElement("canvas");M.width=w,M.height=u,M.style.cssText="width:80px;height:48px";var y=M.getContext("2d");return y.font="bold "+9*r+"px Helvetica,Arial,sans-serif",y.textBaseline="top",y.fillStyle=a,y.fillRect(0,0,w,u),y.fillStyle=s,y.fillText(h,p,d),y.fillRect(f,x,v,m),y.fillStyle=a,y.globalAlpha=.9,y.fillRect(f,x,v,m),{dom:M,update:function(k,C){n=Math.min(n,k),i=Math.max(i,k),y.fillStyle=a,y.globalAlpha=1,y.fillRect(0,0,w,x),y.fillStyle=s,y.fillText(t(k)+" "+h+" ("+t(n)+"-"+t(i)+")",p,d),y.drawImage(M,f+r,x,v-r,m,f,x,v-r,m),y.fillRect(f+v-r,x,r,m),y.fillStyle=a,y.globalAlpha=.9,y.fillRect(f+v-r,x,r,t((1-k/C)*m))}}},c})})(X);const R=H;let W=[],A=new g.DirectionalLight(16777215,1);W.push(A);A.position.set(0,200,100);W.push(new g.AmbientLight(10066329));function T(e){const l=new g.WebGLRenderer({alpha:!0,antialias:!0});return l.setPixelRatio(window.devicePixelRatio),e.windowScale=Math.min(Math.floor(window.innerWidth/e.XW),Math.floor(window.innerHeight/e.YH)),l.setSize(e.windowSize.w,e.windowSize.h),document.body.appendChild(l.domElement),l}function Y({scene:e,onAdd:l,onRemove:c}){const h=[],s={};return{e:h,add:n=>{var i;!Array.isArray(n.tags)&&n.tag&&(n.tags=[n.tag],delete n.tag),n.id||(n.id=((i=n.mesh)==null?void 0:i.uuid)||0),n.id&&(s[n.id]=n),h.push(n),n.mesh&&e.add(n.mesh),typeof l=="function"&&l(n)},removeById:n=>{let i=s[n];if(!i)return console.warn("Entities cannot remove unknown object with id",n);a(i)},remove:a,getById:n=>s[n],getByTag:n=>h.filter(i=>{var t;return(t=i.tags)==null?void 0:t.includes(n)})};function a(n){delete s[n.id];const i=h.indexOf(n);if(i<0)throw new Error("Entities cannot remove unknown object",n);h.splice(i,1),typeof c=="function"&&c(n),n.mesh&&e.remove(n.mesh)}}function z(e,l,c,h){let s=.75*e/2,a;return a=new g.OrthographicCamera(-s*h,s*h,s,-s,100,-100),a.position.set(e/2,l/2,100),a}let B=new g.MeshLambertMaterial({color:2236979,opacity:1,blending:g.NoBlending,side:g.FrontSide,transparent:!1,depthTest:!1,wireframe:!1});const E=new g.Mesh(new g.PlaneGeometry(320,240,10,10),B);E.castShadow=!1;E.receiveShadow=!0;E.position.set(160,120,-1);function P({config:e}){let l=e.blockWidth,c=e.blockHeight;return{worldPos:s,boxel(a,n,i,t,r){let w=l*.8,u=c*.8;typeof t=="number"&&(t=new g.MeshStandardMaterial({color:t}));const p=t&&new g.Mesh(new g.PlaneGeometry(w,u),t);let d="boxel_"+p.id,[f,x]=h(a,n);return d==="boxel_133"&&console.log("boxel_133",f,x),p&&p.position.set(f,x,0),{id:d,tags:i,mesh:p,collider:{grid:{id:d,tags:i,x:f,y:x,w:e.blockWidth,h:e.blockHeight}},update:r}}};function h(a,n){return[e.blockWidth/2+e.blockWidth*a,e.blockHeight/2+e.blockHeight*n]}function s(a,n){return[e.blockWidth*a,e.blockHeight*n]}}function D(e){let c=e(0,0,"bullet",13369344,function(h){this.mesh.position.y+=3*h/10});return console.log("New bullet",c.mesh.id),c.id="bullet"+Date.now(),c}function _({config:e,entities:l}){let{boxel:c}=P({config:e});this.id="player",this.speed={x:0,y:0},this.mesh=new g.Group,this.boxels=[];let h=new g.MeshStandardMaterial({color:16711935}),s=[[0,1,1,0],[0,1,1,0],[1,1,1,1],[1,1,1,1]];for(let i=0;i<4;i++)for(let t=0;t<4;t++){if(!s[3-t][i])continue;let r=c(i,t,"player",h);this.boxels.push(r),this.mesh.add(r.mesh)}this.left=function(){this.direction=-1,this.start=!0,this.speed.x=0},this.right=function(){this.direction=1,this.start=!0,this.speed.x=0},this.shoot=function(){let i=D(c);i.mesh.position.set(this.mesh.position.x+1.5*e.blockWidth,this.mesh.position.y+4*e.blockHeight,this.mesh.position.z),l.add(i)},this.update=function(i){if(this.start&&(this.timer=Date.now(),this.timerOffset=0,this.start=!1),this.direction){let r=Date.now()-this.timer,w=3,u=300;r>=u?(this.direction=0,this.speed.x=0):this.speed.x=this.direction*a(r,0,w,u)}this.boxels.forEach(r=>{r.collider.grid.x=this.mesh.position.x+r.mesh.position.x,r.collider.grid.y=this.mesh.position.y+r.mesh.position.y});let t=this.mesh.position.x+this.speed.x*i/10;t<0||t>=e.XW-3*e.blockWidth?this.speed.x=0:this.mesh.position.x=t};function a(i,t,r,w){let u=i/w,p=u<.5?8*u*u*u*u:1-Math.pow(-2*u+2,4)/2;return n(t,r,p)}function n(i,t,r){return(1-r)*i+r*t}return this.speed={x:0,y:0},this.tags=["player"],this}function I({config:e,scene:l,entities:c,player:h}){const s={floor:new g.MeshStandardMaterial({color:3377203}),roof:new g.MeshStandardMaterial({color:13421772}),blue:new g.MeshStandardMaterial({color:221}),collider:new g.MeshStandardMaterial({color:8912896,transparent:!0,opacity:.5})},{boxel:a,worldPos:n}=P({config:e,scene:l,entities:c});let i=e.blockWidth,t=e.blockHeight,r=e.XW/i,w=e.YH/t;for(let p=0;p<r;p++)for(let d=0;d<w;d++)d<=3?u(p,d,["static","floor"],s.floor):d>w-7&&u(p,d,["static","roof"],s.roof);u(0,4,"boundsLeft",e.showColliders&&s.collider),h.mesh.position.set(...n(10,4),0);function u(p,d,f,x){c.add(a(p,d,f,x))}}function K(e){let l=e.blockWidth,c=e.blockHeight,h=e.XW/l,s=e.YH/c,a=1,n=1;this.grid=[];for(let t=0;t<s;t++)this.grid.push(Array.from({length:h},()=>[]));this.add=function(t){let r=Math.floor(t.x/l),w=Math.ceil(a+t.x/l),u=Math.floor(t.y/c),p=Math.ceil(n+t.y/c);for(let d=u;d<p&&d<this.grid.length;d++)for(let f=r;f<w&&f<this.grid[0].length;f++)this.grid[d][f].indexOf(t)<0&&(t.id==="boxel_133"&&console.log("Adding boxel_133",d,f),this.grid[d][f].push(t))},this.collides=function(t){if(typeof t.x!="number"||typeof t.y!="number"||typeof t.w!="number"||typeof t.h!="number")throw new Exception("Cannot check collision of object",o);let w=Math.floor(t.x/l),u=Math.ceil((a+t.x)/l),p=Math.floor(t.y/c),d=Math.ceil((n+t.y)/c),f=[];for(let x=p;x<=d&&x<this.grid.length;x++)for(let v=w;v<=u&&v<this.grid[0].length;v++)this.grid[x][v].forEach(m=>{(i(t.x+1e-4,m.x,m.x+m.w)||i(t.x+t.w-1e-4,m.x,m.x+m.w))&&(i(t.y+1e-4,m.y,m.y+m.h)||i(t.y+t.h-1e-4,m.y,m.y+m.h))&&t!==m&&f.indexOf(m)<0&&f.push(m)});return f};function i(t,r,w){return t>r&&t<w}return this.remove=function(t){let r=Math.floor(t.x/l),w=Math.ceil((a+t.x)/l),u=Math.floor(t.y/c),p=Math.ceil((n+t.y)/c);for(let d=u;d<p&&d<this.grid.length;d++)for(let f=r;f<w&&f<this.grid[0].length;f++)t.id==="boxel_133"&&console.log("Removing boxel_133",d,f),G(this.grid[d][f],t)},this}function G(e,l){const c=e.indexOf(l);if(c<0)throw new Error("CollisionGrid cannot remove unknown object",l);e.splice(c,1),console.log("GridCollider removed",l)}const S={XW:320,YH:240,blockWidth:5,blockHeight:5,blockScale:.8,windowScale:1,windowSize:{w:window.innerWidth,h:window.innerHeight},showColliders:!0};S.windowAspect=S.windowSize.w/S.windowSize.h;function F(){let e={config:S};e.systems={},e.scene=new g.Scene,e.entities=new Y({onAdd:a,onRemove:n,scene:e.scene}),e.renderer=new T(e.config),e.state={running:!1},e.camera=z(e.config.XW,e.config.YH,e.config.windowScale,e.config.windowAspect),e.player=new _(e),e.state={};let{systems:l,entities:c,scene:h,player:s}=e;return l.gridCollider=new K(S),c.add(l.gridCollider),h.add(e.player.mesh),c.add(e.player),I({config:S,scene:h,entities:c,player:s}),h.add(E),W.forEach(i=>h.add(i)),window.addEventListener("keydown",Q.bind(this),!1),window.addEventListener("resize",V.bind(this),!1),this.update=function(i){let t=e.state.timestamp?i-e.state.timestamp:0;this.entities.e.forEach(r=>{typeof r.update=="function"&&r.update(t)}),e.state.timestamp=i},this.run=function(){this.state.running=!0,window.requestAnimationFrame(this.loop.bind(this))},this.render=function(){this.renderer.render(h,this.camera)},this.loop=function(i){if(!this.state.running){this.state.timestamp=0;return}this.update(i),this.render(),window.requestAnimationFrame(this.loop.bind(this))},l.gridCollider.update=function(){c.getByTag("bullet").forEach(t=>{this.collides({x:t.mesh.position.x,y:t.mesh.position.y,w:t.collider.grid.w,h:t.collider.grid.h}).forEach(r=>{e.entities.removeById(r.id)})})},Object.assign(this,e),this.run(),this;function a(i){var t;(t=i.collider)!=null&&t.grid&&i.tags.includes("static")&&l.gridCollider.add(i.collider.grid),i.boxels&&i.boxels.forEach(r=>{l.gridCollider.add({...r.collider.grid,tags:i.tags})})}function n(i){var t;(t=i.collider)!=null&&t.grid&&i.tags.includes("static")&&l.gridCollider.remove(i.collider.grid),L("Entity removed",i)}}function q(){b.player.shoot()}function N(){b.state.running=b.state.running!==!0,b.state.running&&b.run()}function U(){console.log("debug"),b.state.debug=b.state.debug!==!0}function J(){b.stats.dom.style.display=b.stats.dom.style.display==="none"?"":"none"}function Q(e){let l=null;if(!e.altKey&&!e.ctrlKey)if(["ArrowUp","KeyW"].includes(e.code))l=q();else if(["ArrowLeft","KeyA"].includes(e.code))l=b.player.left();else if(["ArrowRight","KeyD"].includes(e.code))l=b.player.right();else if(e.code==="KeyS")l=console.log(b.scene);else if(e.code==="KeyP")l=N();else if(e.code==="KeyX")l=U();else if(e.code==="KeyO")l=J();else return;else return;return l===null&&(e.preventDefault(),L("Unhandled keypress",e)),l}function L(){b.state.debug&&console.log(...arguments)}function V(){}let b=null;window.addEventListener("DOMContentLoaded",()=>{b=new F,b.stats=new R,document.body.appendChild(b.stats.dom),requestAnimationFrame(function e(){b.stats.update(),requestAnimationFrame(e)}),window._APP=b});
