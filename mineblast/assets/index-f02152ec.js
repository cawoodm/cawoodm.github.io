import*as A from"https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const n of c.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&l(n)}).observe(document,{childList:!0,subtree:!0});function s(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerpolicy&&(c.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?c.credentials="include":r.crossorigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function l(r){if(r.ep)return;r.ep=!0;const c=s(r);fetch(r.href,c)}})();var X=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},H={},z={get exports(){return H},set exports(e){H=e}};(function(e,t){(function(s,l){e.exports=l()})(X,function(){var s=function(){function l(f){return n.appendChild(f.dom),f}function r(f){for(var p=0;p<n.children.length;p++)n.children[p].style.display=p===f?"block":"none";c=f}var c=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",function(f){f.preventDefault(),r(++c%n.children.length)},!1);var a=(performance||Date).now(),i=a,d=0,u=l(new s.Panel("FPS","#0ff","#002")),g=l(new s.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=l(new s.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:n,addPanel:l,showPanel:r,begin:function(){a=(performance||Date).now()},end:function(){d++;var f=(performance||Date).now();if(g.update(f-a,200),f>i+1e3&&(u.update(1e3*d/(f-i),100),i=f,d=0,h)){var p=performance.memory;h.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return f},update:function(){a=this.end()},domElement:n,setMode:r}};return s.Panel=function(l,r,c){var n=1/0,a=0,i=Math.round,d=i(window.devicePixelRatio||1),u=80*d,g=48*d,h=3*d,f=2*d,p=3*d,w=15*d,b=74*d,S=30*d,M=document.createElement("canvas");M.width=u,M.height=g,M.style.cssText="width:80px;height:48px";var x=M.getContext("2d");return x.font="bold "+9*d+"px Helvetica,Arial,sans-serif",x.textBaseline="top",x.fillStyle=c,x.fillRect(0,0,u,g),x.fillStyle=r,x.fillText(l,h,f),x.fillRect(p,w,b,S),x.fillStyle=c,x.globalAlpha=.9,x.fillRect(p,w,b,S),{dom:M,update:function(E,W){n=Math.min(n,E),a=Math.max(a,E),x.fillStyle=c,x.globalAlpha=1,x.fillRect(0,0,u,w),x.fillStyle=r,x.fillText(i(E)+" "+l+" ("+i(n)+"-"+i(a)+")",h,f),x.drawImage(M,p+d,w,b-d,S,p,w,b-d,S),x.fillRect(p+b-d,w,d,S),x.fillStyle=c,x.globalAlpha=.9,x.fillRect(p+b-d,w,d,i((1-E/W)*S))}}},s})})(z);const Y=H;let G=[],q=new A.DirectionalLight(16777215,1);G.push(q);q.position.set(0,200,100);G.push(new A.AmbientLight(10066329));function K(e){const t=new A.WebGLRenderer({alpha:!0,antialias:!0});return t.setPixelRatio(window.devicePixelRatio),e.windowScale=Math.min(Math.floor(window.innerWidth/e.XW),Math.floor(window.innerHeight/e.YH)),t.setSize(e.windowSize.w,e.windowSize.h),document.body.appendChild(t.domElement),t}function J({scene:e,onAdd:t,onRemove:s}){const l=[],r={};return{e:l,add:n=>{var a;!Array.isArray(n.tags)&&n.tags&&(n.tags=[n.tags]),n.id||(n.id=((a=n.mesh)==null?void 0:a.uuid)||0),n.id&&(r[n.id]=n),l.push(n),n.mesh&&e.add(n.mesh),typeof t=="function"&&t(n)},removeById:n=>{let a=r[n];if(!a)return console.warn("Entities cannot remove unknown object with id",n);c(a)},remove:c,getById:n=>r[n],getByTag:n=>l.filter(a=>{var i;return(i=a.tags)==null?void 0:i.includes(n)})};function c(n){delete r[n.id];const a=l.indexOf(n);if(a<0)throw new Error("Entities cannot remove unknown object",n);l.splice(a,1),typeof s=="function"&&s(n),n.mesh&&e.remove(n.mesh)}}function Q(e,t,s,l){let r=.75*e/2,c;return c=new A.OrthographicCamera(-r*l,r*l,r,-r,100,-100),c.position.set(e/2,t/2,100),c}let U=new A.MeshLambertMaterial({color:2236979,opacity:1,blending:A.NoBlending,side:A.FrontSide,transparent:!1,depthTest:!1,wireframe:!1});const R=new A.Mesh(new A.PlaneGeometry(320,240,10,10),U);R.castShadow=!1;R.receiveShadow=!0;R.position.set(160,120,-1);function B({config:e}){let t=e.blockWidth,s=e.blockHeight;return{worldPos:r,boxel(c,n,a,i,d){let u=t*.8,g=s*.8;typeof i=="number"&&(i=new A.MeshStandardMaterial({color:i}));const h=i&&new A.Mesh(new A.PlaneGeometry(u,g),i);let f="boxel_"+h.id,[p,w]=l(c,n);return h&&h.position.set(p,w,0),{id:f,tags:a,mesh:h,collider:{grid:{id:f,tags:a,x:p,y:w,w:e.blockWidth,h:e.blockHeight}},update:d}}};function l(c,n){return[e.blockWidth/2+e.blockWidth*c,e.blockHeight/2+e.blockHeight*n]}function r(c,n){return[e.blockWidth*c,e.blockHeight*n]}}function N(e){let s=e(0,0,"bullet",13369344,function(l){this.mesh.position.y+=4*l/10});return s.id="bullet"+Date.now(),s.damage=0,s}function T(e){e&&(e.setTargetAtTime||(e.setTargetAtTime=e.setTargetValueAtTime))}Object.prototype.hasOwnProperty.call(window,"webkitAudioContext")&&!Object.prototype.hasOwnProperty.call(window,"AudioContext")&&(window.AudioContext=window.AudioContext||window.webkitAudioContext,Object.prototype.hasOwnProperty.call(AudioContext,"createGain")||(AudioContext.prototype.createGain=AudioContext.prototype.createGainNode),Object.prototype.hasOwnProperty.call(AudioContext,"createDelay")||(AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode),Object.prototype.hasOwnProperty.call(AudioContext,"createScriptProcessor")||(AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode),Object.prototype.hasOwnProperty.call(AudioContext,"createPeriodicWave")||(AudioContext.prototype.createPeriodicWave=AudioContext.prototype.createWaveTable),AudioContext.prototype.internal_createGain=AudioContext.prototype.createGain,AudioContext.prototype.createGain=function(){var e=this.internal_createGain();return T(e.gain),e},AudioContext.prototype.internal_createDelay=AudioContext.prototype.createDelay,AudioContext.prototype.createDelay=function(e){var t=e?this.internal_createDelay(e):this.internal_createDelay();return T(t.delayTime),t},AudioContext.prototype.internal_createBufferSource=AudioContext.prototype.createBufferSource,AudioContext.prototype.createBufferSource=function(){var e=this.internal_createBufferSource();return e.start?(e.internal_start=e.start,e.start=function(t,s,l){typeof l<"u"?e.internal_start(t||0,s,l):e.internal_start(t||0,s||0)}):e.start=function(t,s,l){s||l?this.noteGrainOn(t||0,s,l):this.noteOn(t||0)},e.stop?(e.internal_stop=e.stop,e.stop=function(t){e.internal_stop(t||0)}):e.stop=function(t){this.noteOff(t||0)},T(e.playbackRate),e},AudioContext.prototype.internal_createDynamicsCompressor=AudioContext.prototype.createDynamicsCompressor,AudioContext.prototype.createDynamicsCompressor=function(){var e=this.internal_createDynamicsCompressor();return T(e.threshold),T(e.knee),T(e.ratio),T(e.reduction),T(e.attack),T(e.release),e},AudioContext.prototype.internal_createBiquadFilter=AudioContext.prototype.createBiquadFilter,AudioContext.prototype.createBiquadFilter=function(){var e=this.internal_createBiquadFilter();return T(e.frequency),T(e.detune),T(e.Q),T(e.gain),e},Object.prototype.hasOwnProperty.call(AudioContext,"createOscillator")&&(AudioContext.prototype.internal_createOscillator=AudioContext.prototype.createOscillator,AudioContext.prototype.createOscillator=function(){var e=this.internal_createOscillator();return e.start?(e.internal_start=e.start,e.start=function(t){e.internal_start(t||0)}):e.start=function(t){this.noteOn(t||0)},e.stop?(e.internal_stop=e.stop,e.stop=function(t){e.internal_stop(t||0)}):e.stop=function(t){this.noteOff(t||0)},e.setPeriodicWave||(e.setPeriodicWave=e.setWaveTable),T(e.frequency),T(e.detune),e}));var m=new AudioContext;function Z(e,t,s,l,r,c,n,a,i,d,u,g,h,f){e===void 0&&(e=200),t===void 0&&(t=0),s===void 0&&(s=1),l===void 0&&(l="sine"),r===void 0&&(r=1),c===void 0&&(c=0),n===void 0&&(n=0),a===void 0&&(a=0),i===void 0&&(i=!1),d===void 0&&(d=0),u===void 0&&(u=0),g===void 0&&(g=void 0),h===void 0&&(h=void 0);var p,w,b;p=m.createOscillator(),w=m.createGain(),m.createStereoPanner?b=m.createStereoPanner():b=m.createPanner(),p.connect(w),w.connect(b),b.connect(m.destination),w.gain.value=r,m.createStereoPanner?b.pan.value=c:b.setPosition(c,0,1-Math.abs(c)),p.type=l;var S,M=function(y,v){return Math.floor(Math.random()*(v-y+1))+y};d>0?S=M(e-d/2,e+d/2):S=e,p.frequency.value=S,t>0&&W(w),D(w),a>0&&_(p),g&&E(w),h&&x(w),u>0&&F(),L(p);function x(y){var v=m.createConvolver();v.buffer=$(h[0],h[1],h[2],m),y.connect(v),v.connect(b)}function E(y){var v=m.createGain(),O=m.createDelay(),P=m.createBiquadFilter();O.delayTime.value=g[0],v.gain.value=g[1],g[2]&&(P.frequency.value=g[2]),O.connect(v),g[2]?(v.connect(P),P.connect(O)):v.connect(O),y.connect(O),O.connect(b)}function W(y){y.gain.value=0,y.gain.linearRampToValueAtTime(0,m.currentTime+n),y.gain.linearRampToValueAtTime(r,m.currentTime+n+t)}function D(y){y.gain.linearRampToValueAtTime(r,m.currentTime+t+n),y.gain.linearRampToValueAtTime(0,m.currentTime+n+t+s)}function _(y){var v=y.frequency.value;i?(y.frequency.linearRampToValueAtTime(v,m.currentTime+n),y.frequency.linearRampToValueAtTime(v+a,m.currentTime+n+t+s)):(y.frequency.linearRampToValueAtTime(v,m.currentTime+n),y.frequency.linearRampToValueAtTime(v-a,m.currentTime+n+t+s))}function F(){var y=m.createOscillator(),v=m.createOscillator(),O=m.createGain(),P=m.createGain();O.gain.value=r,P.gain.value=r,y.connect(O),O.connect(m.destination),v.connect(P),P.connect(m.destination),y.type="sawtooth",v.type="sawtooth",y.frequency.value=S+u,v.frequency.value=S-u,t>0&&(W(O),W(P)),s>0&&(D(O),D(P)),a>0&&(_(y),_(v)),g&&(E(O),E(P)),h&&(x(O),x(P)),L(y),L(v)}function L(y){y.start(m.currentTime+n),y.stop(m.currentTime+n+2)}}function $(e,t,s,l){for(var r=l.sampleRate*e,c=l.createBuffer(2,r,l.sampleRate),n=c.getChannelData(0),a=c.getChannelData(1),i=0;i<r;i++){var d;s?d=r-i:d=i,n[i]=(Math.random()*2-1)*Math.pow(1-d/r,t),a[i]=(Math.random()*2-1)*Math.pow(1-d/r,t)}return c}function j(e,t,s,l){let r=e/l,c=r<.5?8*r*r*r*r:1-Math.pow(-2*r+2,4)/2;return I(t,s,c)}function V(e,t,s,l){let r=e/l,c=r<.5?2*r:-2*r+2;return I(t,s,c)}function I(e,t,s){return(1-s)*e+s*t}function ee({config:e,entities:t}){let{boxel:s}=B({config:e});this.id="player",this.speed={x:0,y:0},this.mesh=new A.Group,this.boxels=[];let l=new A.MeshStandardMaterial({color:16711935}),r=[[0,1,1,0],[0,1,1,0],[1,1,1,1],[1,1,1,1]];for(let n=0;n<4;n++)for(let a=0;a<4;a++){if(!r[3-a][n])continue;let i=s(n,a,"player",l);this.boxels.push(i),a>2&&(i.mesh.name="barrel"),this.mesh.add(i.mesh)}return this.left=function(){this.direction!==-1&&(this.direction=-1,this.start=!0)},this.right=function(){this.direction!==1&&(this.direction=1,this.start=!0)},this.recoilers=te([this.mesh.children[4],this.mesh.children[5],this.mesh.children[8],this.mesh.children[9]]),this.shoot=function(){let n=N(s);this.recoilers.start(),c(),n.mesh.position.set(this.mesh.position.x+2*e.blockWidth,this.mesh.position.y+3*e.blockHeight,this.mesh.position.z),t.add(n)},this.update=function(n){if(this.recoilers.update(),this.start&&(this.timer=Date.now(),this.timerOffset=0,this.start=!1),this.direction){let i=Date.now()-this.timer,d=4,u=200;i>=u?(this.direction=0,this.speed.x=0):this.speed.x=this.direction*j(i,0,d,u)}this.boxels.forEach(i=>{i.collider.grid.x=this.mesh.position.x+i.mesh.position.x,i.collider.grid.y=this.mesh.position.y+i.mesh.position.y});let a=this.mesh.position.x+this.speed.x*n/10;a<0||a>=e.XW-3*e.blockWidth?this.speed.x=0:this.mesh.position.x=a},this.speed={x:0,y:0},this.tags=["player"],this;function c(){Z(1046.5,.01,.2,"square",.2,-.8,0,3200,!1,0,215,null,void 0)}}function te(e){const t=e.map(s=>ie(s));return{running:!1,start(){this.running&&this.stop(),t.forEach(s=>s.start()),this.running=!0},update(){this.running&&t.forEach(s=>s.update())},stop(){t.forEach(s=>s.stop()),this.running=!1}}}function ie(e){const t=e;return{start(){this.timer=Date.now(),this.timerOffset=0,this.startPosition={y:t.position.y}},update(){let s=Date.now()-this.timer,l=4,r=120;if(s>=r)return this.stop(t);t.position.y=this.startPosition.y-V(s,0,l,r)},stop(){t.position.y=this.startPosition.y}}}function ne({config:e,scene:t,entities:s,player:l}){const r={floor:new A.MeshStandardMaterial({color:3377203}),roof:new A.MeshStandardMaterial({color:13421772}),blue:new A.MeshStandardMaterial({color:221}),collider:new A.MeshStandardMaterial({color:8912896,transparent:!0,opacity:.5})},{boxel:c,worldPos:n}=B({config:e,scene:t,entities:s});let a=e.blockWidth,i=e.blockHeight,d=e.XW/a,u=e.YH/i;for(let h=0;h<d;h++)for(let f=0;f<u;f++)f<=3?g(h,f,["static","floor"],r.floor):f>u-20&&Math.random()>.25&&g(h,f,["static","roof"],r.roof);g(0,4,"boundsLeft",e.showColliders&&r.collider),l.mesh.position.set(...n(10,4),0);function g(h,f,p,w){s.add(c(h,f,p,w))}}function re(e){let t=e.blockWidth,s=e.blockHeight,l=e.XW/t,r=e.YH/s,c=1,n=1;this.grid=[];for(let i=0;i<r;i++)this.grid.push(Array.from({length:l},()=>[]));this.gridLoop=function(i){let d=this.grid;return u=>{let g=Math.floor(i.x/t),h=Math.ceil((c+i.x)/t),f=Math.floor(i.y/s),p=Math.ceil((n+i.y)/s);for(let w=f;w<=p&&w<d.length;w++)for(let b=g;b<=h&&b<d[0].length;b++)u(b,w,i)}},this.add=function(i){if(!i.id)throw new Error("CollisionGrid cannot index objects without an id",o);this.gridLoop(i)((d,u)=>{this.grid[u][d].indexOf(i)<0&&this.grid[u][d].push(i)})},this.collides=function(i){if(typeof i.x!="number"||typeof i.y!="number"||typeof i.w!="number"||typeof i.h!="number")throw new Error("Cannot check collision of object",i);let u=[];return this.gridLoop(i)((g,h)=>{this.grid[h][g].forEach(f=>{(a(i.x+1e-4,f.x,f.x+f.w)||a(i.x+i.w-1e-4,f.x,f.x+f.w))&&(a(i.y+1e-4,f.y,f.y+f.h)||a(i.y+i.h-1e-4,f.y,f.y+f.h))&&i!==f&&u.indexOf(f)<0&&u.push(f)})}),u};function a(i,d,u){return i>d&&i<u}return this.remove=function(i){this.gridLoop(i)((d,u)=>{oe(this.grid[u][d],i)})},this}function oe(e,t){if(!t.id)throw new Error("CollisionGrid cannot remove objects without an id",t);const s=e.findIndex(l=>l.id===t.id);if(s<0)throw new Error("CollisionGrid cannot remove unknown object",t);e.splice(s,1)}const k={XW:320,YH:240,blockWidth:5,blockHeight:5,blockScale:.8,windowScale:1,windowSize:{w:window.innerWidth,h:window.innerHeight},showColliders:!0};k.windowAspect=k.windowSize.w/k.windowSize.h;function se(){let e={config:k};e.systems={},e.scene=new A.Scene,e.entities=new J({onAdd:c,onRemove:n,scene:e.scene}),e.renderer=new K(e.config),e.state={running:!1},e.camera=Q(e.config.XW,e.config.YH,e.config.windowScale,e.config.windowAspect),e.player=new ee(e),e.state={};let{systems:t,entities:s,scene:l,player:r}=e;return t.gridCollider=new re(k),s.add(t.gridCollider),l.add(e.player.mesh),s.add(e.player),ne({config:k,scene:l,entities:s,player:r}),l.add(R),G.forEach(a=>l.add(a)),window.addEventListener("keydown",fe.bind(this),!1),window.addEventListener("resize",he.bind(this),!1),this.update=function(a){let i=e.state.timestamp?a-e.state.timestamp:0;this.entities.e.forEach(d=>{typeof d.update=="function"&&d.update(i)}),e.state.timestamp=a},this.run=function(){this.state.running=!0,window.requestAnimationFrame(this.loop.bind(this))},this.render=function(){this.renderer.render(l,this.camera)},this.loop=function(a){if(!this.state.running){this.state.timestamp=0;return}this.update(a),this.render(),window.requestAnimationFrame(this.loop.bind(this))},t.gridCollider.update=function(){s.getByTag("bullet").forEach(i=>{this.collides({x:i.mesh.position.x,y:i.mesh.position.y,w:i.collider.grid.w,h:i.collider.grid.h}).forEach(u=>{e.entities.removeById(u.id),++i.damage>2&&s.removeById(i.id)})})},Object.assign(this,e),this.run(),this;function c(a){var i,d;(i=a.collider)!=null&&i.grid&&a.tags.includes("static")&&t.gridCollider.add(a.collider.grid),(d=a.boxels)==null||d.forEach(u=>{t.gridCollider.add({...u.collider.grid,tags:a.tags})})}function n(a){var i;(i=a.collider)!=null&&i.grid&&a.tags.includes("static")&&t.gridCollider.remove(a.collider.grid)}}function ae(){C.player.shoot()}function le(){C.state.running=C.state.running!==!0,C.state.running&&C.run()}function de(){C.state.debug=C.state.debug!==!0}function ce(){C.stats.dom.style.display=C.stats.dom.style.display==="none"?"":"none"}function fe(e){let t=null;if(!e.altKey&&!e.ctrlKey)if(["ArrowUp","KeyW"].includes(e.code))t=ae();else if(["ArrowLeft","KeyA"].includes(e.code))t=C.player.left();else if(["ArrowRight","KeyD"].includes(e.code))t=C.player.right();else if(e.code==="KeyS")t=console.log(C.scene);else if(e.code==="KeyP")t=le();else if(e.code==="KeyX")t=de();else if(e.code==="KeyO")t=ce();else return;else return;return t===null&&(e.preventDefault(),ue("Unhandled keypress",e)),t}function ue(){C.state.debug&&console.log(...arguments)}function he(){}let C=null;window.addEventListener("DOMContentLoaded",()=>{C=new se,C.stats=new Y,document.body.appendChild(C.stats.dom),requestAnimationFrame(function e(){C.stats.update(),requestAnimationFrame(e)}),window._APP=C});
