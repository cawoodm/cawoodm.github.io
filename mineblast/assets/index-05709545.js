import*as b from"https://cdn.jsdelivr.net/npm/three@0.118/build/three.module.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&l(n)}).observe(document,{childList:!0,subtree:!0});function s(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerpolicy&&(a.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?a.credentials="include":r.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function l(r){if(r.ep)return;r.ep=!0;const a=s(r);fetch(r.href,a)}})();var F=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},H={},z={get exports(){return H},set exports(e){H=e}};(function(e,t){(function(s,l){e.exports=l()})(F,function(){var s=function(){function l(c){return n.appendChild(c.dom),c}function r(c){for(var f=0;f<n.children.length;f++)n.children[f].style.display=f===c?"block":"none";a=c}var a=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",function(c){c.preventDefault(),r(++a%n.children.length)},!1);var o=(performance||Date).now(),i=o,d=0,m=l(new s.Panel("FPS","#0ff","#002")),w=l(new s.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var u=l(new s.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:n,addPanel:l,showPanel:r,begin:function(){o=(performance||Date).now()},end:function(){d++;var c=(performance||Date).now();if(w.update(c-o,200),c>i+1e3&&(m.update(1e3*d/(c-i),100),i=c,d=0,u)){var f=performance.memory;u.update(f.usedJSHeapSize/1048576,f.jsHeapSizeLimit/1048576)}return c},update:function(){o=this.end()},domElement:n,setMode:r}};return s.Panel=function(l,r,a){var n=1/0,o=0,i=Math.round,d=i(window.devicePixelRatio||1),m=80*d,w=48*d,u=3*d,c=2*d,f=3*d,g=15*d,A=74*d,h=30*d,M=document.createElement("canvas");M.width=m,M.height=w,M.style.cssText="width:80px;height:48px";var x=M.getContext("2d");return x.font="bold "+9*d+"px Helvetica,Arial,sans-serif",x.textBaseline="top",x.fillStyle=a,x.fillRect(0,0,m,w),x.fillStyle=r,x.fillText(l,u,c),x.fillRect(f,g,A,h),x.fillStyle=a,x.globalAlpha=.9,x.fillRect(f,g,A,h),{dom:M,update:function(P,E){n=Math.min(n,P),o=Math.max(o,P),x.fillStyle=a,x.globalAlpha=1,x.fillRect(0,0,m,g),x.fillStyle=r,x.fillText(i(P)+" "+l+" ("+i(n)+"-"+i(o)+")",u,c),x.drawImage(M,f+d,g,A-d,h,f,g,A-d,h),x.fillRect(f+A-d,g,d,h),x.fillStyle=a,x.globalAlpha=.9,x.fillRect(f+A-d,g,d,i((1-P/E)*h))}}},s})})(z);const I=H;let L=[],q=new b.DirectionalLight(16777215,1);L.push(q);q.position.set(0,200,100);L.push(new b.AmbientLight(10066329));function K(e){const t=new b.WebGLRenderer({alpha:!0,antialias:!0});return t.setPixelRatio(window.devicePixelRatio),e.windowScale=Math.min(Math.floor(window.innerWidth/e.XW),Math.floor(window.innerHeight/e.YH)),t.setSize(e.windowSize.w,e.windowSize.h),document.body.appendChild(t.domElement),t}function J({scene:e,onAdd:t,onRemove:s}){const l=[],r={};return{e:l,add:n=>{var o;!Array.isArray(n.tags)&&n.tag&&(n.tags=[n.tag],delete n.tag),n.id||(n.id=((o=n.mesh)==null?void 0:o.uuid)||0),n.id&&(r[n.id]=n),l.push(n),n.mesh&&e.add(n.mesh),typeof t=="function"&&t(n)},removeById:n=>{let o=r[n];o&&a(o)},remove:a,getById:n=>r[n],getByTag:n=>l.filter(o=>{var i;return(i=o.tags)==null?void 0:i.includes(n)})};function a(n){delete r[n.id];const o=l.indexOf(n);if(o<0)throw new Error("Entities cannot remove unknown object",n);l.splice(o,1),typeof s=="function"&&s(n),n.mesh&&e.remove(n.mesh)}}function Q(e,t,s,l){let r=.75*e/2,a;return a=new b.OrthographicCamera(-r*l,r*l,r,-r,100,-100),a.position.set(e/2,t/2,100),a}let U=new b.MeshLambertMaterial({color:2236979,opacity:1,blending:b.NoBlending,side:b.FrontSide,transparent:!1,depthTest:!1,wireframe:!1});const W=new b.Mesh(new b.PlaneGeometry(320,240,10,10),U);W.castShadow=!1;W.receiveShadow=!0;W.position.set(160,120,-1);function G({config:e}){let t=e.blockWidth,s=e.blockHeight;return{worldPos:r,boxel(a,n,o,i,d){let m=t*.8,w=s*.8;typeof i=="number"&&(i=new b.MeshStandardMaterial({color:i}));const u=i&&new b.Mesh(new b.PlaneGeometry(m,w),i);let c="boxel_"+u.id,[f,g]=l(a,n);return u&&u.position.set(f,g,0),{id:c,tags:o,mesh:u,collider:{grid:{id:c,tags:o,x:f,y:g,w:e.blockWidth,h:e.blockHeight}},update:d}}};function l(a,n){return[e.blockWidth/2+e.blockWidth*a,e.blockHeight/2+e.blockHeight*n]}function r(a,n){return[e.blockWidth*a,e.blockHeight*n]}}function N(e){let s=e(0,0,"bullet",13369344,function(l){this.mesh.position.y+=4*l/10});return s.id="bullet"+Date.now(),s}function T(e){e&&(e.setTargetAtTime||(e.setTargetAtTime=e.setTargetValueAtTime))}Object.prototype.hasOwnProperty.call(window,"webkitAudioContext")&&!Object.prototype.hasOwnProperty.call(window,"AudioContext")&&(window.AudioContext=window.AudioContext||window.webkitAudioContext,Object.prototype.hasOwnProperty.call(AudioContext,"createGain")||(AudioContext.prototype.createGain=AudioContext.prototype.createGainNode),Object.prototype.hasOwnProperty.call(AudioContext,"createDelay")||(AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode),Object.prototype.hasOwnProperty.call(AudioContext,"createScriptProcessor")||(AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode),Object.prototype.hasOwnProperty.call(AudioContext,"createPeriodicWave")||(AudioContext.prototype.createPeriodicWave=AudioContext.prototype.createWaveTable),AudioContext.prototype.internal_createGain=AudioContext.prototype.createGain,AudioContext.prototype.createGain=function(){var e=this.internal_createGain();return T(e.gain),e},AudioContext.prototype.internal_createDelay=AudioContext.prototype.createDelay,AudioContext.prototype.createDelay=function(e){var t=e?this.internal_createDelay(e):this.internal_createDelay();return T(t.delayTime),t},AudioContext.prototype.internal_createBufferSource=AudioContext.prototype.createBufferSource,AudioContext.prototype.createBufferSource=function(){var e=this.internal_createBufferSource();return e.start?(e.internal_start=e.start,e.start=function(t,s,l){typeof l<"u"?e.internal_start(t||0,s,l):e.internal_start(t||0,s||0)}):e.start=function(t,s,l){s||l?this.noteGrainOn(t||0,s,l):this.noteOn(t||0)},e.stop?(e.internal_stop=e.stop,e.stop=function(t){e.internal_stop(t||0)}):e.stop=function(t){this.noteOff(t||0)},T(e.playbackRate),e},AudioContext.prototype.internal_createDynamicsCompressor=AudioContext.prototype.createDynamicsCompressor,AudioContext.prototype.createDynamicsCompressor=function(){var e=this.internal_createDynamicsCompressor();return T(e.threshold),T(e.knee),T(e.ratio),T(e.reduction),T(e.attack),T(e.release),e},AudioContext.prototype.internal_createBiquadFilter=AudioContext.prototype.createBiquadFilter,AudioContext.prototype.createBiquadFilter=function(){var e=this.internal_createBiquadFilter();return T(e.frequency),T(e.detune),T(e.Q),T(e.gain),e},Object.prototype.hasOwnProperty.call(AudioContext,"createOscillator")&&(AudioContext.prototype.internal_createOscillator=AudioContext.prototype.createOscillator,AudioContext.prototype.createOscillator=function(){var e=this.internal_createOscillator();return e.start?(e.internal_start=e.start,e.start=function(t){e.internal_start(t||0)}):e.start=function(t){this.noteOn(t||0)},e.stop?(e.internal_stop=e.stop,e.stop=function(t){e.internal_stop(t||0)}):e.stop=function(t){this.noteOff(t||0)},e.setPeriodicWave||(e.setPeriodicWave=e.setWaveTable),T(e.frequency),T(e.detune),e}));var y=new AudioContext;function Z(e,t,s,l,r,a,n,o,i,d,m,w,u,c){e===void 0&&(e=200),t===void 0&&(t=0),s===void 0&&(s=1),l===void 0&&(l="sine"),r===void 0&&(r=1),a===void 0&&(a=0),n===void 0&&(n=0),o===void 0&&(o=0),i===void 0&&(i=!1),d===void 0&&(d=0),m===void 0&&(m=0),w===void 0&&(w=void 0),u===void 0&&(u=void 0);var f,g,A;f=y.createOscillator(),g=y.createGain(),y.createStereoPanner?A=y.createStereoPanner():A=y.createPanner(),f.connect(g),g.connect(A),A.connect(y.destination),g.gain.value=r,y.createStereoPanner?A.pan.value=a:A.setPosition(a,0,1-Math.abs(a)),f.type=l;var h,M=function(p,v){return Math.floor(Math.random()*(v-p+1))+p};d>0?h=M(e-d/2,e+d/2):h=e,f.frequency.value=h,t>0&&E(g),D(g),o>0&&R(f),w&&P(g),u&&x(g),m>0&&Y(),_(f);function x(p){var v=y.createConvolver();v.buffer=$(u[0],u[1],u[2],y),p.connect(v),v.connect(A)}function P(p){var v=y.createGain(),O=y.createDelay(),S=y.createBiquadFilter();O.delayTime.value=w[0],v.gain.value=w[1],w[2]&&(S.frequency.value=w[2]),O.connect(v),w[2]?(v.connect(S),S.connect(O)):v.connect(O),p.connect(O),O.connect(A)}function E(p){p.gain.value=0,p.gain.linearRampToValueAtTime(0,y.currentTime+n),p.gain.linearRampToValueAtTime(r,y.currentTime+n+t)}function D(p){p.gain.linearRampToValueAtTime(r,y.currentTime+t+n),p.gain.linearRampToValueAtTime(0,y.currentTime+n+t+s)}function R(p){var v=p.frequency.value;i?(p.frequency.linearRampToValueAtTime(v,y.currentTime+n),p.frequency.linearRampToValueAtTime(v+o,y.currentTime+n+t+s)):(p.frequency.linearRampToValueAtTime(v,y.currentTime+n),p.frequency.linearRampToValueAtTime(v-o,y.currentTime+n+t+s))}function Y(){var p=y.createOscillator(),v=y.createOscillator(),O=y.createGain(),S=y.createGain();O.gain.value=r,S.gain.value=r,p.connect(O),O.connect(y.destination),v.connect(S),S.connect(y.destination),p.type="sawtooth",v.type="sawtooth",p.frequency.value=h+m,v.frequency.value=h-m,t>0&&(E(O),E(S)),s>0&&(D(O),D(S)),o>0&&(R(p),R(v)),w&&(P(O),P(S)),u&&(x(O),x(S)),_(p),_(v)}function _(p){p.start(y.currentTime+n),p.stop(y.currentTime+n+2)}}function $(e,t,s,l){for(var r=l.sampleRate*e,a=l.createBuffer(2,r,l.sampleRate),n=a.getChannelData(0),o=a.getChannelData(1),i=0;i<r;i++){var d;s?d=r-i:d=i,n[i]=(Math.random()*2-1)*Math.pow(1-d/r,t),o[i]=(Math.random()*2-1)*Math.pow(1-d/r,t)}return a}function V(e,t,s,l){let r=e/l,a=r<.5?8*r*r*r*r:1-Math.pow(-2*r+2,4)/2;return B(t,s,a)}function j(e,t,s,l){let r=e/l,a=r<.5?2*r:-2*r+2;return B(t,s,a)}function B(e,t,s){return(1-s)*e+s*t}function ee({config:e,entities:t}){let{boxel:s}=G({config:e});this.id="player",this.speed={x:0,y:0},this.mesh=new b.Group,this.boxels=[];let l=new b.MeshStandardMaterial({color:16711935}),r=[[0,1,1,0],[0,1,1,0],[1,1,1,1],[1,1,1,1]];for(let n=0;n<4;n++)for(let o=0;o<4;o++){if(!r[3-o][n])continue;let i=s(n,o,"player",l);this.boxels.push(i),o>2&&(i.mesh.name="barrel"),this.mesh.add(i.mesh)}return this.left=function(){this.direction!==-1&&(this.direction=-1,this.start=!0)},this.right=function(){this.direction!==1&&(this.direction=1,this.start=!0)},this.recoiler=te(),this.shoot=function(){let n=N(s);console.log(this.mesh),this.recoiler.start(this.mesh.children[5]),a(),n.mesh.position.set(this.mesh.position.x+2*e.blockWidth,this.mesh.position.y+3*e.blockHeight,this.mesh.position.z),t.add(n)},this.update=function(n){if(this.recoiler.running&&this.recoiler.update(this.mesh.children[5]),this.start&&(this.timer=Date.now(),this.timerOffset=0,this.start=!1),this.direction){let i=Date.now()-this.timer,d=4,m=200;i>=m?(this.direction=0,this.speed.x=0):this.speed.x=this.direction*V(i,0,d,m)}this.boxels.forEach(i=>{i.collider.grid.x=this.mesh.position.x+i.mesh.position.x,i.collider.grid.y=this.mesh.position.y+i.mesh.position.y});let o=this.mesh.position.x+this.speed.x*n/10;o<0||o>=e.XW-3*e.blockWidth?this.speed.x=0:this.mesh.position.x=o},this.speed={x:0,y:0},this.tags=["player"],this;function a(){Z(1046.5,.01,.2,"square",.2,-.8,0,3200,!1,0,215,null,void 0)}}function te(){return{running:!1,start(e){this.running&&this.stop(e),this.running=!0,this.timer=Date.now(),this.timerOffset=0,this.startPosition={y:e.position.y}},update(e){let t=Date.now()-this.timer,s=3,l=110;if(t>=l)return console.log("stop at",e.position.y,"should be",this.startPosition.y),this.stop(e);e.position.y=this.startPosition.y-j(t,0,s,l)},stop(e){e.position.y=this.startPosition.y,this.running=!1}}}function ie({config:e,scene:t,entities:s,player:l}){const r={floor:new b.MeshStandardMaterial({color:3377203}),roof:new b.MeshStandardMaterial({color:13421772}),blue:new b.MeshStandardMaterial({color:221}),collider:new b.MeshStandardMaterial({color:8912896,transparent:!0,opacity:.5})},{boxel:a,worldPos:n}=G({config:e,scene:t,entities:s});let o=e.blockWidth,i=e.blockHeight,d=e.XW/o,m=e.YH/i;for(let u=0;u<d;u++)for(let c=0;c<m;c++)c<=3?w(u,c,["static","floor"],r.floor):c>m-7&&w(u,c,["static","roof"],r.roof);w(0,4,"boundsLeft",e.showColliders&&r.collider),l.mesh.position.set(...n(10,4),0);function w(u,c,f,g){s.add(a(u,c,f,g))}}function ne(e){let t=e.blockWidth,s=e.blockHeight,l=e.XW/t,r=e.YH/s,a=1,n=1;this.grid=[];for(let i=0;i<r;i++)this.grid.push(Array.from({length:l},()=>[]));this.add=function(i){let d=Math.floor(i.x/t),m=Math.ceil(a+i.x/t),w=Math.floor(i.y/s),u=Math.ceil(n+i.y/s);for(let c=w;c<u&&c<this.grid.length;c++)for(let f=d;f<m&&f<this.grid[0].length;f++)this.grid[c][f].indexOf(i)<0&&this.grid[c][f].push(i)},this.collides=function(i){if(typeof i.x!="number"||typeof i.y!="number"||typeof i.w!="number"||typeof i.h!="number")throw new Error("Cannot check collision of object",i);let m=Math.floor(i.x/t),w=Math.ceil((a+i.x)/t),u=Math.floor(i.y/s),c=Math.ceil((n+i.y)/s),f=[];for(let g=u;g<=c&&g<this.grid.length;g++)for(let A=m;A<=w&&A<this.grid[0].length;A++)this.grid[g][A].forEach(h=>{(o(i.x+1e-4,h.x,h.x+h.w)||o(i.x+i.w-1e-4,h.x,h.x+h.w))&&(o(i.y+1e-4,h.y,h.y+h.h)||o(i.y+i.h-1e-4,h.y,h.y+h.h))&&i!==h&&f.indexOf(h)<0&&f.push(h)});return f};function o(i,d,m){return i>d&&i<m}return this.remove=function(i){let d=Math.floor(i.x/t),m=Math.ceil((a+i.x)/t),w=Math.floor(i.y/s),u=Math.ceil((n+i.y)/s);for(let c=w;c<u&&c<this.grid.length;c++)for(let f=d;f<m&&f<this.grid[0].length;f++)re(this.grid[c][f],i)},this}function re(e,t){const s=e.indexOf(t);if(s<0)throw new Error("CollisionGrid cannot remove unknown object",t);e.splice(s,1)}const k={XW:320,YH:240,blockWidth:5,blockHeight:5,blockScale:.8,windowScale:1,windowSize:{w:window.innerWidth,h:window.innerHeight},showColliders:!0};k.windowAspect=k.windowSize.w/k.windowSize.h;function oe(){let e={config:k};e.systems={},e.scene=new b.Scene,e.entities=new J({onAdd:a,onRemove:n,scene:e.scene}),e.renderer=new K(e.config),e.state={running:!1},e.camera=Q(e.config.XW,e.config.YH,e.config.windowScale,e.config.windowAspect),e.player=new ee(e),e.state={};let{systems:t,entities:s,scene:l,player:r}=e;return t.gridCollider=new ne(k),s.add(t.gridCollider),l.add(e.player.mesh),s.add(e.player),ie({config:k,scene:l,entities:s,player:r}),l.add(W),L.forEach(o=>l.add(o)),window.addEventListener("keydown",ce.bind(this),!1),window.addEventListener("resize",fe.bind(this),!1),this.update=function(o){let i=e.state.timestamp?o-e.state.timestamp:0;this.entities.e.forEach(d=>{typeof d.update=="function"&&d.update(i)}),e.state.timestamp=o},this.run=function(){this.state.running=!0,window.requestAnimationFrame(this.loop.bind(this))},this.render=function(){this.renderer.render(l,this.camera)},this.loop=function(o){if(!this.state.running){this.state.timestamp=0;return}this.update(o),this.render(),window.requestAnimationFrame(this.loop.bind(this))},t.gridCollider.update=function(){s.getByTag("bullet").forEach(i=>{this.collides({x:i.mesh.position.x,y:i.mesh.position.y,w:i.collider.grid.w,h:i.collider.grid.h}).forEach(d=>{e.entities.removeById(d.id)})})},Object.assign(this,e),this.run(),this;function a(o){var i;(i=o.collider)!=null&&i.grid&&o.tags.includes("static")&&t.gridCollider.add(o.collider.grid),o.boxels&&o.boxels.forEach(d=>{t.gridCollider.add({...d.collider.grid,tags:o.tags})})}function n(o){var i;(i=o.collider)!=null&&i.grid&&o.tags.includes("static")&&t.gridCollider.remove(o.collider.grid),X("Entity removed",o)}}function se(){C.player.shoot()}function le(){C.state.running=C.state.running!==!0,C.state.running&&C.run()}function ae(){C.state.debug=C.state.debug!==!0}function de(){C.stats.dom.style.display=C.stats.dom.style.display==="none"?"":"none"}function ce(e){let t=null;if(!e.altKey&&!e.ctrlKey)if(["ArrowUp","KeyW"].includes(e.code))t=se();else if(["ArrowLeft","KeyA"].includes(e.code))t=C.player.left();else if(["ArrowRight","KeyD"].includes(e.code))t=C.player.right();else if(e.code==="KeyS")t=console.log(C.scene);else if(e.code==="KeyP")t=le();else if(e.code==="KeyX")t=ae();else if(e.code==="KeyO")t=de();else return;else return;return t===null&&(e.preventDefault(),X("Unhandled keypress",e)),t}function X(){C.state.debug&&console.log(...arguments)}function fe(){}let C=null;window.addEventListener("DOMContentLoaded",()=>{C=new oe,C.stats=new I,document.body.appendChild(C.stats.dom),requestAnimationFrame(function e(){C.stats.update(),requestAnimationFrame(e)}),window._APP=C});
