(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class E extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"});const t=document.getElementById("data-entry-template");this.shadowRoot.appendChild(t.content.cloneNode(!0)),this.dataArray=[],this.columns=[],this.filters=[],this.elementRect={},this.sortColumn=-1,this.sortDirection="asc"}connectedCallback(){if(this.storageKey=this.getAttribute("storage-key"),!this.storageKey)throw new Error("Data Table requires a storage-key attribute.");if(this.dataInput=this.shadowRoot.querySelector(".input-container textarea"),!this.dataInput)throw new Error("Data input element not found in template.");this.tableContainer=this.shadowRoot.querySelector(".table-container"),this.alertBox=this.shadowRoot.querySelector(".alert"),this.handleKeyPress=this.handleKeyPress.bind(this),this.dataInput.addEventListener("keypress",this.handleKeyPress),this.dataInput.addEventListener("drop",this.handleDataInputDrop.bind(this)),this.loadFromStorage(),this.renderTable(),this.saveToStorage()}handleDataInputDrop(t){if(t.preventDefault(),!t.dataTransfer.files.length)return;var e=t.dataTransfer.files[0],s=new FileReader;const i=this.dataInput,n=this.processInput.bind(this);s.onload=function(r){i.value=r.target.result,n()},s.readAsText(e,"UTF-8")}createdCallback(t){}resizedCallback(t,e){e<40||(this.elementRect.width=t,this.elementRect.height=e,this.saveToStorage())}movedCallback(t,e){this.elementRect.x=t,this.elementRect.y=e,this.saveToStorage()}minimizedCallback(t,e){this.elementRect.minimized=!0,this.saveToStorage()}maximizedCallback(t,e){this.elementRect.maximized=!0,this.saveToStorage()}restoredCallback(t,e){this.elementRect.minimized=!1,this.elementRect.maximized=!1,this.saveToStorage()}handleKeyPress(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.processInput())}processInput(){if(!this.dataInput)throw new Error("Data input element not found in template.");const t=this.dataInput.value.trim().split(`
`).map(n=>n.trim()).filter(n=>n.length>0);if(t.length===0)return;const e=t[0].includes(";")?";":t[0].includes("	")?"	":",";let s=0,i=0;for(const n of t){s++;const r=this.parseCSV(n.trim(),e);if(r.length!==0){if(this.dataArray.length===0&&s===1&&typeof this.columns[0]>"u"){let o=null;if(r.every(a=>this.detectType(a)==="string")){o=r;let a=t.length>1?this.parseCSV(t[1],e):r;this.establishColumns(a,o);continue}this.establishColumns(r)}try{this.processLine(r)}catch(o){if(!(o instanceof m))throw o;if(i==0&&t.length>5){if(alert(`Line ${s} failed: ${o.message}`),confirm("Do you want to stop processing? Pressing no/cancel now will skip all invalid rows silently!"))return;i++}else if(i>0)i++,console.warn(`Line ${s} failed: ${o.message}`);else{this.showAlert(`Line ${s} failed: ${o.message}`,"error");return}}}}this.dataInput.value="",i==0?this.showAlert("Data added successfully!"):this.showAlert(`Data imported, ${i} lines skipped!`),this.renderTable(),this.saveToStorage()}processLine(t){t=this.convertNulls(t),this.setDefaults(t),this.validateTypes(t),this.addDataRow(t)}convertNulls(t){return t.map(e=>e==="null"||e==="NULL"||e==="undefined"||e==="undefined"?null:e)}parseCSV(t,e){const s=[];let i="",n=!1;for(let r=0;r<t.length;r++){const o=t[r];o==='"'?n=!n:o===e&&!n?(s.push(i.trim()),i=""):i+=o}return s.push(i.trim()),s.map(r=>r.startsWith('"')&&r.endsWith('"')?r.slice(1,-1):r)}detectType(t){if(t.toLowerCase()==="true"||t.toLowerCase()==="false")return"boolean";if(/^\d{4}-\d{2}-\d{2}$/.test(t)){const e=new Date(t);if(!isNaN(e.getTime()))return"date"}return!isNaN(parseFloat(t))&&isFinite(t)?"number":"string"}serializeToDB(t,e){if(t===null||typeof t>"u")return null;switch(e){case"boolean":return t.toLowerCase()==="true";case"number":return parseFloat(t);case"date":return new Date(t).toISOString().split("T")[0];default:return t}}establishColumns(t,e){if(e&&e.length!==t.length)throw new m("Header and 1st data row length mismatch!");this.columns=t.map((s,i)=>{let n={field:(e==null?void 0:e[i])||`field_${i+1}`,name:(e==null?void 0:e[i])||`Column ${i+1}`,type:this.detectType(s),default:null,max:0};if(e){const r=(e[i]+"::::").split(":");r[0]&&(n.field=r[0]),r[1]&&(n.name=r[1]),r[2]&&(n.type=r[2]),r[3]&&(n.default=r[3]),r[4]&&(n.max=parseInt(r[4]))}return n}),this.filters=new Array(this.columns.length).fill("")}setDefaults(t){this.columns.forEach((e,s)=>{if(!t[s]){let i=e.default;typeof i<"u"&&(t[s]=i),t[s]=null}})}validateTypes(t){if(t.length>this.columns.length)throw new m(`Too many values (${t.length}) for a table of this column count (${this.columns.length})!`);for(let e=0;e<t.length;e++){if(t[e]===null)continue;const s=this.detectType(t[e]);if(this.columns[e].type!=="string"&&s!==this.columns[e].type)throw new m(`Column ${e} "${t[e]}" of wrong type (${s}): should be ${this.columns[e].type}!`)}}addDataRow(t){const e=t.map((s,i)=>this.serializeToDB(s,this.columns[i].type));return this.dataArray.push(e),!0}renderTable(t){t=t||[...this.dataArray];let e="<table>";e+="<thead><tr>",this.columns.forEach((s,i)=>{let n=s.name;const r=s.type;let o=[r];this.sortColumn===i&&o.push(this.sortDirection),e+=`<th data-index="${i}" class="${o.join(" ")}"><span class="column-name" data-index="${i}" title="${s.field}:${r}">${n}</span></th>`}),e+="<th class=actions>+</th></tr></thead>",e+="<tbody>",this.sortColumn!==-1&&t.sort((s,i)=>{const n=s[this.sortColumn],r=i[this.sortColumn];if(this.columns[this.sortColumn].type==="date"){const o=new Date(n),a=new Date(r);return this.sortDirection==="asc"?o.getTime()-a.getTime():a.getTime()-o.getTime()}else{if(this.columns[this.sortColumn].type==="number")return this.sortDirection==="asc"?n-r:r-n;{const o=String(n).toLowerCase(),a=String(r).toLowerCase();return this.sortDirection==="asc"?o.localeCompare(a):a.localeCompare(o)}}}),e+=`<tr class="filter-row ${this.filters.find(s=>!!s)?"":"hide"}">`+this.columns.map((s,i)=>`<td><input class="filter-input" fieldIndex="${i}" value="${this.filters[i]}"/></td>`).join(" ")+"<td></td></tr>",t.forEach((s,i)=>{const n=this.dataArray.findIndex(r=>JSON.stringify(r)===JSON.stringify(s));e+="<tr>",s.forEach((r,o)=>{let a=r;const c=this.columns[o].type;let u=[c];if(r===null&&(a="",u.push("null")),c==="boolean")a=`<input type='checkbox' ${r&&"checked"} dataIndex="${n}" fieldIndex="${o}">`;else if(c==="date"){try{a=new Date(r).toISOString().split("T")[0]}catch{console.warn("Invalid date",r,"in row",i+1,"column",o+1,s.join(", "))}a=`<input type="date" class="dataInput" dataIndex="${n}" fieldIndex="${o}" value="${a}">`}else c==="string"&&a.match(/^#[0-9A-F]{6}$/i)?a=`<div style="width: 20px; height: 20px; border:1px solid silver; background-color: ${r};"></div>`:a=`<input class="dataInput" dataIndex="${n}" fieldIndex="${o}" value="${a}">`;e+=`<td class="${u.join(" ")}">${a}</td>`}),e+=`<td class=actions><button class="delete-btn" data-index="${n}">&nbsp;</button></td>`,e+="</tr>"}),t.length===0&&(e+='<tr><td colspan="50" id="emptyDrag">Enter your first data row to establish columns and data types.</td></tr>'),e+="</tbody></table>",this.tableContainer.innerHTML=e,this.addTableEventListeners()}addTableEventListeners(){this.shadowRoot.querySelectorAll("td input.filter-input").forEach(r=>{r.addEventListener("keypress",o=>{if(o.key!=="Enter")return;o.preventDefault();const a=parseInt(r.getAttribute("fieldIndex")),d=r.value.toLowerCase();this.filters[a]=d;const c=this.dataArray.filter(u=>String(u[a]).toLowerCase().includes(d));this.renderTable(c)})}),this.shadowRoot.querySelectorAll("td input").forEach(r=>{r.addEventListener("change",o=>{const a=o.target,d=parseInt(r.getAttribute("fieldIndex")),c=parseInt(r.getAttribute("dataIndex")),u=this.columns[d];if(a.type==="checkbox")this.dataArray[c][d]=r.checked;else{const h=r.value;if(u.type==="number"&&isNaN(h))return alert("Invalid number");if(u.type==="date"&&!new Date(h))return alert("Invalid date");this.dataArray[c][d]=this.serializeToDB(h,u.type)}this.saveToStorage()})}),this.shadowRoot.querySelectorAll("th:not(:last-child)").forEach(r=>{r.addEventListener("click",o=>{if(o.target.classList.contains("column-name"))return;const a=parseInt(r.getAttribute("data-index"));this.sortColumn===a?this.sortDirection=="desc"?this.sortColumn=-1:this.sortDirection=this.sortDirection==="asc"?"desc":"asc":(this.sortColumn=a,this.sortDirection="asc"),this.saveToStorage(),this.renderTable()})}),this.shadowRoot.querySelector("th:last-child").addEventListener("click",r=>{let o=prompt("Enter new column (field:name:type:default)");if(!o)return;let a=(o+":::").split(":"),d=a[0],c=a[1]||this._toTitleCase(d),u=a[3],h=a[2]||this.detectType(u);u=this.serializeToDB(u,h),this.columns.push({field:d,name:c,type:h}),this.dataArray.forEach(S=>{S.push(u)}),this.saveToStorage(),this.renderTable()}),this.shadowRoot.querySelectorAll(".column-name").forEach(r=>{r.addEventListener("dblclick",o=>{o.stopPropagation();const a=parseInt(r.getAttribute("data-index")),d=this.columns[a];d.name;const c=document.createElement("input");c.type="text",c.placeholder="Rename: field:name:type:default:maxlength",c.title=c.placeholder,c.value=d.field+":"+d.name+":"+d.type+":"+(d.default||"")+":"+(d.max||0),c.style.width="100%",c.style.padding="2px",c.style.boxSizing="border-box";const u=r.parentNode;u.replaceChild(c,r),c.focus(),c.addEventListener("click",h=>{h.stopPropagation()}),c.addEventListener("keyup",h=>{h.key==="Escape"&&u.replaceChild(r,c)}),c.addEventListener("keypress",h=>{h.key==="Enter"&&this.saveColumnName(a,c.value)})})}),this.shadowRoot.querySelectorAll(".delete-btn").forEach(r=>{r.addEventListener("click",()=>{const o=parseInt(r.getAttribute("data-index"));this.deleteRow(o)})})}_toTitleCase(t){return t.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substring(1).toLowerCase())}saveColumnName(t,e){if(!e){confirm("Are you sure you want to delete this column?")&&(this.columns.splice(t,1),this.dataArray.forEach(i=>{i.splice(t,1)}),this.sortColumn===t&&(this.sortColumn=-1,this.sortDirection="asc"),this.saveToStorage(),this.renderTable());return}this.columns[t].name=e.trim()||`Column ${t+1}`;const s=e.split(":");s.length>1?(this.columns[t].field=s[0],this.columns[t].name=s[1],s.length>2&&(this.columns[t].type=s[2]),s.length>3&&(this.columns[t].default=s[3]),s.length>4&&(this.columns[t].max=parseInt(s[4]))):e.startsWith("!")?(this.columns[t].field=e.substring(1).trim().replace(/\s+/g,"_").toLowerCase(),this.columns[t].name=e.substring(1).trim()):this.columns[t].field.match(/field_\d+/)&&(this.columns[t].field=e.trim().replace(/\s+/g,"_").toLowerCase()),this.saveToStorage(),this.renderTable()}deleteRow(t){this.dataArray.splice(t,1),this.saveToStorage(),this.renderTable()}saveToStorage(){if(!this.storageKey)return;const t={dataArray:this.dataArray,columns:this.columns,elementRect:this.elementRect,sortColumn:this.sortColumn,sortDirection:this.sortDirection};try{window.store.set(this.storageKey,t)}catch(e){alert("Data could not be persisted: "+e.message)}}loadFromStorage(){try{const t=window.store.get(this.storageKey);if(t){const e=t;this.dataArray=e.dataArray,this.columns=e.columns,this.elementRect=e.elementRect,this.sortColumn=e.sortColumn||-1,this.sortDirection=e.sortDirection||"asc",this.filters=new Array(this.columns.length).fill("")}}catch(t){console.error("Data could not be loaded: "+t.message)}}showAlert(t,e="success"){this.alertBox.className="alert "+e,this.alertBox.textContent=t,this.alertBox.style.display="block",setTimeout(()=>{this.alertBox.style.display="none"},5e3)}refresh(){this.loadFromStorage(),this.renderTable()}clearData(){this.dataArray=[],this.columns=[],this.saveToStorage(),this.renderTable()}exportData(){return{data:this.dataArray,columns:this.columns,elementRect:this.elementRect}}exportDataCSV(){const t=this.columns.map(n=>i(n.field)).join(","),e=this.dataArray.map(s).join(`
`);return t+`
`+e;function s(n){return n.map(i)}function i(n){return typeof n=="string"&&n.includes(",")?`"${n}"`:n}}importData(t){return t&&t.data&&t.columns&&t.types?(this.dataArray=t.data,this.columns=t.columns,this.saveToStorage(),this.renderTable(),!0):!1}}class m extends Error{constructor(t="",...e){super(t,...e)}}function A(l){return{dir({path:t="/",suffix:e=""}={}){return Object.entries(localStorage).filter(s=>!l||s[0].startsWith(l)).filter(s=>s[0].startsWith(t)).filter(s=>!e||s[0].endsWith(e)).map(([s,i])=>[s.replace(l,""),JSON.parse(i)])},get(t){if(!t)throw new Error("Store.get failed: Key is required");let e=localStorage.getItem(l+t);try{e=JSON.parse(e)}catch{}return typeof e>"u"&&(e=defaultValue),e},set(t,e){if(!t)throw new Error("Store.set failed: Key is required");localStorage.setItem(l+t,JSON.stringify(e))},delete(t){localStorage.removeItem(l+t)}}}const I="https://api.github.com",L=function(l){return{async request(t){const e=t.url.startsWith("http")?t.url:I+t.url;return await fetch(e,{...t,body:JSON.stringify(t.data,null,2),headers:{...this._authHeader(),...t==null?void 0:t.headers,"User-Agent":"Gist-Client"}})},async get(t,e={}){return this.request({...e,method:"GET",url:t})},delete(t,e={}){return this.request({...e,method:"DELETE",url:t})},post(t,e=void 0,s={}){return this.request({...s,method:"POST",url:t,data:e})},put(t,e=void 0,s={}){return this.request({...s,method:"PUT",url:t,data:e})},patch(t,e=void 0,s={}){return this.request({...s,method:"PATCH",url:t,data:e})},create(t,e){return this.post("/gists",t,e)},update(t,e,s={}){return this.patch(`/gists/${t}`,e,{headers:{Accept:"application/vnd.github+jso",...s}})},async getOne(t,e){return this.get(`/gists/${t}`,e)},delOne(t,e){return this.delete(`/gists/${t}`,e)},_authHeader(){return l?{Authorization:`Bearer ${l}`}:{}}}};function D(l,t,e){i();const s=L(t);function i(){if(!l)throw new Error("Gist user name missing.");if(!t)throw new Error("Gist API Token missing.");if(!e)throw new Error("GistId missing.")}return{async save(){i();let n={};store.dir({suffix:".table.json"}).forEach(([r,o])=>{n[r]={type:"application/json",filename:r,content:JSON.stringify(o,null,2)}}),await s.update(e,{description:"MinniDBMax data",files:n}),console.debug("Data saved to Gist!")},async load(){i();let r=await(await s.getOne(e)).json();Object.keys(r.files).filter(o=>o.endsWith(".table.json")).forEach(o=>{const a=JSON.parse(r.files[o].content),d=o.replace(".table.json","");if(!a)throw new Error("No data found for table: "+d);store.set(o,a)}),console.debug("Data loaded from Gist!",`https://gist.github.com/${l}/${e}`)}}}addEventListener("error",function(l){alert(l.message)});customElements.define("data-entry-table",E);var p=new URLSearchParams(location.search);const $=p.has("space")&&p.get("space")||localStorage.getItem("/minnidbmax/.currentStore")||"default";window.store=A(`/minnidbmax/${$}/`);const y=store.get(".gist-user"),g=store.get(".gist-token"),b=store.get(".gist-id"),w=D(y,g,b);function f(){return y?g?b?!0:(alert("Please set your Gist token in browser store with key '/minnidbmax/.gist-id'."),!1):(alert("Please set your Gist token in browser store with key '/minnidbmax/.gist-token'."),!1):(alert("Please set your Git username in browser store with key '/minnidbmax/.gist-user'."),!1)}async function k(){if(!f())return!1;await w.save()}async function x(){if(!f())return!1;f();try{await w.load(),v()}catch(l){alert("Error loading data from Gist: "+l.message),console.error(l)}}function R(){const l={};store.dir().forEach(([t,e])=>l[t]=e),T("minnidbmax.json",JSON.stringify(l,null,2))}function N(){let l=prompt("Enter table title:");if(!l)return;let t=l.replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();if(store.get(t+".table.json")){alert("Table with this name already exists. Please choose a different name.");return}C(t)}function T(l,t){var e=document.createElement("a");e.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download",l),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}function C(l,t){var n,r;const e=document.createElement("data-entry-table");e.setAttribute("storage-key",`${l}.table.json`),e.setAttribute("id","table-"+l);let s=new WinBox(i(l),{mount:e,onresize:e.resizedCallback.bind(e),onmove:e.movedCallback.bind(e),onminimize:e.minimizedCallback.bind(e),onmaximize:e.maximizedCallback.bind(e),onrestore:e.restoredCallback.bind(e),onclose:()=>z(this,e)});s.removeControl("wb-full"),s.addControl({class:"wb-full",image:"icon-filter.svg",click:function(o,a){document.getElementById("table-"+l).shadowRoot.querySelector(".filter-row").classList.toggle("hide")}}),s.addControl({class:"wb-full",image:"icon-data-input.svg",click:function(o,a){e.shadowRoot.querySelector(".input-container").classList.toggle("hide"),e.shadowRoot.querySelector(".input-container textarea").focus()}}),s.addControl({class:"wb-full",image:"icon-download-outline.svg",click:function(o,a){const d=e.exportDataCSV();T(l+".csv",d),this.classList.toggle("active")}}),t!=null&&t.elementRect&&(s.move(t.elementRect.x,t.elementRect.y),s.resize(t.elementRect.width,t.elementRect.height)),(n=t==null?void 0:t.elementRect)!=null&&n.minimized?s.minimize(!0):(r=t==null?void 0:t.elementRect)!=null&&r.maximized&&s.maximize(!0);function i(o){return o.replace(/\w\S*/g,a=>a.charAt(0).toUpperCase()+a.substring(1).toLowerCase())}}function z(l,t){if(!confirm("Are you sure you want to delete this table?"))return;let e=t.getAttribute("storage-key");store.delete(e)}function v(){store.dir({suffix:".table.json"}).forEach(([l,t])=>{let e=l.replace(".table.json",""),s=document.querySelector("#table-"+e);if(s)s.refresh();else try{C(e,t)}catch(i){alert(`Error loading table (${e}) data:`,i.message)}})}document.addEventListener("DOMContentLoaded",function(){v(),console.debug("Data loaded from browser store"),document.getElementById("dataPush").addEventListener("click",k),document.getElementById("dataPull").addEventListener("click",x),document.getElementById("dataDump").addEventListener("click",R),document.getElementById("addTable").addEventListener("click",N)});
